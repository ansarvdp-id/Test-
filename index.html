<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Kotha App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --wa-header-bg: #005c97; /* A deep, rich blue */
            --wa-accent-blue: #34B7F1; /* A vibrant, modern blue for accents */
            --wa-message-out-bg: #e1f6fb; /* A very light blue for sent messages */
            --wa-message-in-bg: #ffffff;
            --wa-app-bg: #f0f2f5; /* Light grey background, common in modern apps */
            --wa-chat-bg: #e5ddd5; /* Classic WhatsApp pattern background color */
            --wa-icon-color: #f0f2f5;
            --wa-text-primary: #111b21;
            --wa-text-secondary: #667781;
            --wa-border-color: #e9edef;
            --wa-active-tab-indicator: var(--wa-accent-blue);
            --wa-button-color: #008069; /* Kept a green shade for buttons for familiarity */
            --wa-link-color: #00a8e8;
            --wa-shadow: rgba(17, 27, 33, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #d1d7db; /* The grey area outside the app */
        }

        body {
            color: var(--wa-text-primary);
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #aaa; }
        
        /* --- General UI Elements --- */
        .icon-btn {
            background: none;
            border: none;
            color: var(--wa-icon-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            position: relative;
        }
        .icon-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .icon-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        
        .text-icon-btn {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border-radius: 8px;
            border: 1px solid var(--wa-border-color);
            background-color: transparent;
            color: var(--wa-header-bg);
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .text-icon-btn:hover {
            background-color: var(--wa-app-bg);
        }
        .text-icon-btn svg {
            width: 24px;
            height: 24px;
            fill: var(--wa-header-bg);
        }
        .text-icon-btn.primary {
            background-color: var(--wa-header-bg);
            color: white;
            border-color: var(--wa-header-bg);
        }
        .text-icon-btn.primary svg {
            fill: white;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            max-height: 950px;
            background-color: var(--wa-app-bg);
            box-shadow: 0 12px 28px 0 var(--wa-shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            border-radius: 8px;
        }

        .view {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
        }
        .view main {
            width: 100%;
            flex-grow: 1;
            overflow-y: auto;
        }

        .page-header {
             width: 100%;
             padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--wa-header-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0;
            color: var(--wa-icon-color);
        }
        .page-title {
            font-size: 20px;
            font-weight: 500;
            flex-grow: 1; /* Title will take up space */
        }

        /* --- NEW: Loading View --- */
        #loading-view {
            justify-content: center;
            background-color: #fff;
        }
        .loader {
            border: 4px solid var(--wa-app-bg);
            border-top: 4px solid var(--wa-header-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Auth View --- */
        #auth-view { justify-content: center; padding: 40px 20px; }
        .app-title { font-size: 36px; font-weight: 700; color: var(--wa-header-bg); margin-bottom: 40px; text-align: center; }
        .auth-form { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 16px; }
        .auth-form input, .auth-form select { border-radius: 8px; border: 1px solid #ccc; background-color: #fff; color: var(--wa-text-primary); padding: 14px; font-family: 'Roboto', sans-serif; font-size: 16px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
        .auth-form input:focus, .auth-form select:focus { outline: none; border-color: var(--wa-header-bg); box-shadow: 0 0 0 2px rgba(0, 92, 151, 0.2); }
        .auth-form button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 14px; cursor: pointer; width: 100%; transition: background-color 0.2s; }
        .auth-form button:hover { background-color: #004c7a; }
        .form-switch-text { color: var(--wa-text-secondary); font-size: 14px; text-align: center; margin-top: 10px; }
        .form-switch-text a { color: var(--wa-link-color); text-decoration: none; cursor: pointer; font-weight: 500; }
        .error-message { color: #d93025; font-size: 13px; text-align: center; min-height: 20px; }

        /* --- Main View --- */
        #main-view { display: none; }
        header.main-header { width: 100%; background-color: var(--wa-header-bg); padding: 10px 15px 0; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); z-index: 5; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-size: 20px; font-weight: 500; color: var(--wa-icon-color); }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .header-nav { display: flex; justify-content: space-around; margin-top: 15px; }
        .nav-tab { background: none; border: none; color: rgba(255, 255, 255, 0.7); font-family: 'Roboto', sans-serif; font-size: 14px; font-weight: 700; cursor: pointer; padding: 12px 16px; flex-grow: 1; border-bottom: 3px solid transparent; transition: color 0.2s, border-color 0.2s; position: relative; text-transform: uppercase; }
        .nav-tab.active { color: var(--wa-active-tab-indicator); border-bottom-color: var(--wa-active-tab-indicator); }
        .badge { position: absolute; top: -2px; right: -4px; background-color: #d93025; color: white; border-radius: 10px; font-size: 11px; padding: 2px 6px; font-weight: 500; display: none; border: 1px solid var(--wa-header-bg); }
        #main-content { width: 100%; flex-grow: 1; overflow-y: auto; background-color: #fff; }
        .content-panel { display: none; }
        .content-panel.active { display: block; }
        .list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; background-color: #fff; border-bottom: 1px solid var(--wa-border-color); transition: background-color 0.2s; }
        .list-item:hover { background-color: var(--wa-app-bg); }
        .list-item:last-child { border-bottom: none; }
        .list-item-profile-img { margin-right: 15px; width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background-color: #ccc; }
        .list-item-details { flex-grow: 1; }
        .list-item-name { font-weight: 500; font-size: 17px; margin-bottom: 2px; }
        .list-item-subtext { font-size: 14px; color: var(--wa-text-secondary); }
        .list-item-actions { display: flex; gap: 10px; }
        .list-item-actions button { background-color: var(--wa-accent-blue); color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 500; }
        .list-item-actions button.reject { background-color: var(--wa-text-secondary); }

        /* --- Notification View --- */
        #notifications-view main { padding-top: 10px; }
        .notification-section h3 { padding: 10px 15px; font-size: 16px; color: var(--wa-header-bg); background-color: var(--wa-app-bg); border-bottom: 1px solid var(--wa-border-color); }
        .notification-item {
            display: flex;
            gap: 10px; align-items: center; padding: 10px 15px;
            border-bottom: 1px solid var(--wa-border-color);
            cursor: pointer;
        }
        .notification-item:hover { background-color: var(--wa-app-bg); }
        .notification-item.unread {
            background-color: #e8f0fe; /* A light blue to indicate unread */
        }

        /* --- Modals --- */
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center; z-index: 30; }
        .modal-content { background-color: #fff; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        .modal-content h2 { text-align: center; color: var(--wa-header-bg); font-weight: 500; margin-bottom: 10px; }
        .modal-content label { font-weight: 500; margin-top: 5px; }
        .modal-content select, .modal-content textarea, .modal-content input[type="date"], .modal-content input[type="number"] {
            border-radius: 8px; border: 1px solid #ccc; background-color: var(--wa-app-bg); 
            color: var(--wa-text-primary); padding: 12px 15px; font-family: 'Roboto', sans-serif; 
            font-size: 16px; width: 100%;
        }
        .modal-content input[type="text"], .modal-content input[type="password"] { border-radius: 8px; border: 1px solid #ccc; background-color: var(--wa-app-bg); color: var(--wa-text-primary); padding: 12px 15px; font-family: 'Roboto', sans-serif; font-size: 16px; width: 100%; }
        .modal-content button { border-radius: 8px; background-color: var(--wa-header-bg); color: white; font-weight: 500; font-family: 'Roboto', sans-serif; font-size: 16px; border: none; padding: 12px 20px; cursor: pointer; width: 100%; }
        .modal-content button.secondary { background-color: var(--wa-text-secondary); }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px; }
        .image-upload-label { cursor: pointer; padding: 12px; border: 2px dashed #ccc; border-radius: 8px; text-align: center; color: var(--wa-text-secondary); transition: all 0.2s; }
        .image-upload-label:hover { border-color: var(--wa-header-bg); background-color: #f8f8f8; }
        #qr-code-display { padding: 20px; display: flex; justify-content: center; align-items: center; }
        #image-preview-display img { max-width: 100%; max-height: 50vh; border-radius: 8px; }
        
        /* --- Profile View --- */
        #profile-view main, #user-profile-view main { width: 100%; padding: 0; }
        #profile-info-display, #user-profile-info-display { text-align: center; padding-bottom: 20px; position: relative; }
        .profile-cover-photo { width: 100%; height: 160px; object-fit: cover; background-color: #ccc; }
        .profile-main-info { padding: 0 20px; margin-top: -50px; position: relative; z-index: 2; }
        #profile-info-display img.profile-img, #user-profile-info-display img.profile-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid #fff; }
        #profile-info-display .name, #user-profile-info-display .name { font-size: 22px; font-weight: 500; margin-top: 5px; }
        #profile-info-display .jgId, #user-profile-info-display .jgId { font-size: 14px; color: var(--wa-text-secondary); }
        
        #profile-options { display: flex; flex-direction: column; gap: 5px; padding: 0 20px 20px; }
        #profile-edit-form { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; padding: 0 20px 20px; }
        #blocked-users-section { margin-top: 15px; padding: 0 20px 20px; border-top: 8px solid var(--wa-app-bg); }
        #blocked-users-section h3 { padding: 15px 0 10px; font-weight: 500; color: var(--wa-header-bg); }
        #logout-btn { background-color: #d93025; margin: 0 20px 20px; width: calc(100% - 40px);}
        #blocked-users-list .list-item { background-color: transparent; }
        #blocked-users-list .list-item-actions button { background-color: var(--wa-accent-blue); font-size: 12px; padding: 6px 10px; }
        
        #profile-stats, #user-profile-stats {
            width: 100%;
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding: 15px 0;
            border-top: 1px solid var(--wa-border-color);
             border-bottom: 1px solid var(--wa-border-color);
        }
        .stat-item {
            text-align: center;
        }
        .stat-item span {
            display: block;
        }
        .stat-item span:first-child {
            font-size: 20px;
            font-weight: 700;
            color: var(--wa-header-bg);
        }
        .stat-item span:last-child {
            font-size: 14px;
            color: var(--wa-text-secondary);
        }
        .blue-badge {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 5px;
            vertical-align: middle;
        }

        /* --- QR Scanner View --- */
        #qr-scanner-view { background-color: #000; }
        #qr-reader { width: 100%; max-width: 500px; }

        /* --- Post Styles --- */
        #posts-content { padding: 0; }
        .create-post-container {
            padding: 15px;
            border-bottom: 8px solid var(--wa-app-bg);
            background-color: #fff;
        }
        #post-textarea {
            width: 100%;
            border: 1px solid var(--wa-border-color);
            border-radius: 8px;
            padding: 10px;
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .create-post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        #add-post-image-btn {
            padding: 10px;
            border: none;
            background-color: var(--wa-app-bg);
            color: var(--wa-button-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #add-post-image-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--wa-button-color);
        }
        #post-image-preview-container {
            margin-bottom: 10px;
            position: relative;
        }
        #post-image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            display: block;
        }
        #remove-post-image-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .post-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            cursor: pointer;
        }
        #create-post-btn {
             width: 100%;
             padding: 12px; border: none; background-color: var(--wa-button-color); color: white; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 15px;
             flex-grow: 1;
        }
        .post-card {
            background-color: #fff;
            border-bottom: 1px solid var(--wa-border-color);
            padding: 15px;
        }
        .post-card.highlight {
            animation: highlight-anim 2s ease-out;
        }
        @keyframes highlight-anim {
            0% { background-color: #e3f2fd; }
            100% { background-color: #fff; }
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .post-author-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }
        .post-author-info {
             flex-grow: 1;
        }
        .post-author-info .name {
            font-weight: 500;
            cursor: pointer;
        }
        .post-author-info .timestamp {
            font-size: 12px;
            color: var(--wa-text-secondary);
        }
        .sponsored-label {
            font-size: 11px;
            font-weight: 700;
            color: #E77F01;
            text-transform: uppercase;
        }
        .post-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 15px;
        }
        .post-content .see-more-btn {
            color: var(--wa-link-color);
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            padding: 0 5px;
        }
        .post-actions {
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--wa-border-color);
            padding-top: 8px;
        }
        .post-action-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--wa-text-secondary);
            font-weight: 500;
            font-size: 14px;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-basis: 0;
            flex-grow: 1;
            justify-content: center;
        }
        .post-action-btn:hover {
            background-color: var(--wa-app-bg);
        }
        .post-action-btn.liked {
            color: var(--wa-accent-blue);
        }
        .post-action-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        .post-comments-section {
            padding: 0 15px 15px;
            background-color: #fff;
            border-bottom: 8px solid var(--wa-app-bg);
        }
        .comment-item {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            position: relative;
        }
        .comment-item:hover .comment-delete-btn { opacity: 1; }
        .comment-delete-btn {
            position: absolute;
            top: 5px; right: 5px;
            font-size: 11px; color: var(--wa-text-secondary);
            cursor: pointer; opacity: 0; transition: opacity 0.2s;
        }
        .comment-author-img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .comment-content {
            background-color: var(--wa-app-bg);
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 14px;
            width: 100%;
            position: relative;
        }
        .comment-author-name {
            font-weight: 500;
            font-size: 13px;
        }
        .comment-actions {
            font-size: 12px;
            font-weight: 500;
            color: var(--wa-text-secondary);
            margin-top: 4px;
        }
        .comment-actions .reply-btn { cursor: pointer; }
        .reply-item {
            margin-left: 40px;
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        /* NEW: Post 3-Dot Menu Styles */
        .post-menu-btn {
            color: var(--wa-text-secondary);
            padding: 4px;
        }
        .post-menu-btn:hover {
            background-color: var(--wa-app-bg);
        }
        .post-menu-btn svg {
             width: 20px; height: 20px;
        }
        .post-dropdown-menu {
            display: none;
            position: absolute;
            top: 30px;
            right: 0;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--wa-shadow);
            z-index: 16; /* Higher than chat menu */
            overflow: hidden;
            width: 180px;
        }
        .post-dropdown-menu button {
            background: none; border: none; padding: 12px 16px; width: 100%;
            text-align: left; cursor: pointer; font-size: 15px; color: var(--wa-text-primary);
        }
        .post-dropdown-menu button:hover {
            background-color: var(--wa-app-bg);
        }
        
        /* NEW: Boost CTA Button Styles */
        .boost-cta-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            background-color: var(--wa-button-color);
            color: white;
            font-family: 'Roboto', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        .boost-cta-button:hover {
            background-color: #006a5a;
        }


        /* My Posts View Styles */
        #my-posts-list .post-card {
            border-bottom: 1px solid var(--wa-border-color);
            padding-bottom: 5px;
        }
        .post-controls {
            display: flex;
            gap: 15px;
            margin-left:auto; /* Pushes the controls to the right */
        }
        .post-control-btn {
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }
        .delete-post-btn { color: #d93025; }
        .edit-post-btn { color: var(--wa-header-bg); }

        /* USER PROFILE VIEW SPECIFIC */
        #user-profile-actions {
            padding: 0 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* NEW: Post Image View Modal */
        #post-image-view-modal .modal-content {
            padding: 10px;
        }
        #post-image-view-modal img {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 8px;
        }
        #post-image-view-modal button {
            width: auto;
            margin-top: 10px;
        }

        /* --- Badge Request View Styles --- */
        #badge-request-view main {
            padding: 20px;
        }
        #badge-packages-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .badge-package-option {
            border: 1px solid var(--wa-border-color);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: box-shadow 0.2s, transform 0.2s;
            cursor: default;
            background-color: #fff;
        }
        .badge-package-option:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .badge-package-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .badge-package-header h3 {
            color: var(--wa-header-bg);
            margin: 0;
            font-size: 20px;
        }
        .badge-package-icon {
            width: 32px;
            height: 32px;
        }
        .badge-package-features {
            list-style: none;
            padding: 0;
            margin: 15px 0;
            color: var(--wa-text-secondary);
            font-size: 14px;
        }
        .badge-package-features li {
            margin-bottom: 5px;
        }
        .badge-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--wa-button-color);
            margin-bottom: 15px;
        }
        .badge-purchase-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--wa-button-color);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .badge-purchase-btn:hover {
            background-color: #006a5a;
        }

        /* --- Wallet View Styles --- */
        #wallet-view main {
            padding: 20px;
            background-color: var(--wa-app-bg);
        }
        .wallet-card {
            background-color: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--wa-shadow);
            margin-bottom: 20px;
        }
        .total-balance-card {
            text-align: center;
            background: linear-gradient(45deg, var(--wa-header-bg), var(--wa-accent-blue));
            color: white;
        }
        .total-balance-card .balance-title {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        .total-balance-card .balance-amount {
            font-size: 36px;
            font-weight: 700;
        }
        .balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--wa-border-color);
        }
        .balance-item:last-child {
            border-bottom: none;
        }
        .balance-item .balance-title {
            font-weight: 500;
        }
        .balance-item .balance-amount {
            font-size: 18px;
            font-weight: 500;
            color: var(--wa-button-color);
        }
        .history-section h3 {
            font-size: 18px;
            color: var(--wa-header-bg);
            margin-bottom: 10px;
        }
        .transaction-list {
            background-color: #fff;
            border-radius: 12px;
            padding: 0 15px;
        }
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--wa-border-color);
        }
        .transaction-item:last-child {
            border-bottom: none;
        }
        .transaction-details .reason {
            font-weight: 500;
            font-size: 15px;
        }
        .transaction-details .timestamp {
            font-size: 12px;
            color: var(--wa-text-secondary);
        }
        .transaction-amount {
            font-weight: 700;
            font-size: 16px;
        }
        .transaction-amount.credit {
            color: #2e7d32;
        }
        .transaction-amount.debit {
            color: #c62828;
        }

        /* NEW: Boost Dashboard Styles */
        #boost-dashboard-view main {
            padding: 20px;
            background-color: var(--wa-app-bg);
        }
        #boost-dashboard-list { display: flex; flex-direction: column; gap: 15px; }
        .boost-dashboard-item {
            background-color: #fff;
            border: 1px solid var(--wa-border-color);
            border-radius: 8px;
            padding: 12px;
        }
        .boost-item-header { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
        .boost-item-header img { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; }
        .boost-item-details { flex-grow: 1; }
        .boost-item-details p { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; font-size: 14px; margin: 0; }
        .boost-status { font-weight: 700; font-size: 13px; padding: 3px 8px; border-radius: 12px; color: white; }
        .boost-status.pending { background-color: #f57c00; }
        .boost-status.active { background-color: #388e3c; }
        .boost-status.ended { background-color: var(--wa-text-secondary); }
        .boost-status.rejected { background-color: #d32f2f; }

        .boost-item-stats { display: flex; justify-content: space-around; text-align: center; padding: 10px 0; border-top: 1px solid var(--wa-border-color); border-bottom: 1px solid var(--wa-border-color); margin-bottom: 10px; }
        .boost-stat { font-size: 13px; color: var(--wa-text-secondary); }
        .boost-stat span { display: block; font-size: 16px; font-weight: 700; color: var(--wa-text-primary); }
        .boost-item-footer { font-size: 12px; text-align: center; color: var(--wa-text-secondary); }
        
        /* CHAT VIEW STYLES - IMPORTANT FOR FIX */
        #chat-view {
            display: none; /* Keep this hidden by default */
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .message-bubble {
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            font-size: 15px;
        }
        .message-received {
            background-color: var(--wa-message-in-bg);
            align-self: flex-start;
            border-top-left-radius: 4px;
        }
        .message-sent {
            background-color: var(--wa-message-out-bg);
            align-self: flex-end;
            border-top-right-radius: 4px;
        }
        #chat-input-container {
            padding: 8px 12px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            background-color: var(--wa-app-bg);
            flex-shrink: 0;
        }
        #chat-input {
            flex-grow: 1;
            border-radius: 20px;
            border: 1px solid var(--wa-border-color);
            padding: 10px 15px;
            font-size: 16px;
            resize: none;
            max-height: 100px;
            overflow-y: auto;
        }
        #chat-send-btn {
            border: none;
            background-color: var(--wa-button-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

    </style>
</head>
<body>
    <div id="app-container">
        <!-- Loading View -->
        <div id="loading-view" class="view">
            <div class="loader"></div>
        </div>

        <!-- Auth View -->
        <div id="auth-view" class="view" style="display: none;">
            <h1 class="app-title">Kotha App</h1>
            <form id="login-form" class="auth-form">
                <div id="login-error" class="error-message"></div>
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit">Log In</button>
                <p class="form-switch-text">Don't have an account? <a id="show-signup">Sign up</a></p>
            </form>
            <form id="signup-form" class="auth-form" style="display: none;">
                <div id="signup-error" class="error-message"></div>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit">Sign Up</button>
                <p class="form-switch-text">Already have an account? <a id="show-login">Log in</a></p>
            </form>
        </div>

        <!-- Main View -->
        <div id="main-view" class="view">
            <header class="main-header">
                <div class="header-top">
                    <span class="header-title">Kotha App</span>
                    <div class="header-actions">
                         <button id="notification-btn" class="icon-btn" title="Notifications">
                            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"></path></svg>
                            <span id="notification-badge" class="badge"></span>
                        </button>
                        <button id="add-friend-btn" class="icon-btn" title="Add Friend">
                            <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                        </button>
                        <button id="menu-btn" class="icon-btn" title="Profile & Settings" style="padding: 0;">
                            <img id="header-profile-img" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23f0f2f5'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        </button>
                    </div>
                </div>
                <nav class="header-nav">
                    <button id="nav-posts" class="nav-tab active">Post</button>
                    <button id="nav-channels" class="nav-tab">Channels</button>
                </nav>
            </header>
        
            <main id="main-content">
                <div id="posts-content" class="content-panel active">
                    <div class="create-post-container">
                        <textarea id="post-textarea" placeholder="What's on your mind?"></textarea>
                        <div id="post-image-preview-container" style="display: none;">
                            <img id="post-image-preview" src="" alt="Image Preview">
                            <button id="remove-post-image-btn">&times;</button>
                        </div>
                        <input type="file" id="post-image-input" accept="image/*" style="display: none;">
                        <div class="create-post-actions">
                             <button id="add-post-image-btn">
                                <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"></path></svg>
                                Photo
                            </button>
                            <button id="create-post-btn">Post</button>
                        </div>
                    </div>
                    <div id="posts-feed"></div>
                </div>
                
                <div id="channels-content" class="content-panel">
                    <div style="padding: 15px; border-bottom: 1px solid var(--wa-border-color);">
                        <div style="display:flex; gap:10px; align-items:stretch;">
                            <input type="text" id="join-channel-input" placeholder="Enter channel code" style="flex-grow:1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 14px;">
                            <button id="join-channel-btn" style="border: none; background-color: var(--wa-header-bg); color: white; border-radius: 8px; cursor: pointer; font-weight: 500; padding: 0 15px;">Join</button>
                            <button id="scan-join-channel-btn" class="icon-btn" title="Scan Channel QR" style="color: var(--wa-header-bg); background-color: var(--wa-app-bg); border-radius: 8px;">
                                 <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg>
                            </button>
                        </div>
                        <p style="text-align: center; margin: 15px 0 5px;">OR</p>
                        <button id="show-create-channel-modal-btn" style="width: 100%; padding: 12px; border: none; background-color: var(--wa-button-color); color: white; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 15px;">Create a New Channel</button>
                    </div>
                    <div id="channel-list"></div>
                </div>
            </main>
        </div>

        <!-- Notifications View -->
        <div id="notifications-view" class="view" style="display: none;">
             <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Notifications</span>
             </header>
            <main>
                <div class="notification-section">
                    <h3>Post Notifications</h3>
                    <div id="post-notifications-list"></div>
                </div>
                <div class="notification-section">
                    <h3>Friend Requests</h3>
                    <div id="friend-requests-list"></div>
                </div>
                 <div class="notification-section">
                     <h3>Call History</h3>
                    <div id="call-logs-list"></div>
                </div>
            </main>
        </div>

        <!-- My Posts View -->
        <div id="my-posts-view" class="view" style="display: none;">
             <header class="page-header">
                 <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">My Posts</span>
             </header>
            <main>
                   <div id="my-posts-list" style="width:100%;"></div>
            </main>
        </div>
        
        <!-- NEW: Boost Dashboard View -->
        <div id="boost-dashboard-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Boost Dashboard</span>
            </header>
            <main>
                <div id="boost-dashboard-list"></div>
            </main>
        </div>

        <!-- My Profile View -->
        <div id="profile-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">My Profile</span>
            </header>
            <main>
                <div id="profile-info-display">
                    <img class="profile-cover-photo" alt="Cover Photo">
                    <div class="profile-main-info">
                        <img class="profile-img" alt="Profile Picture">
                        <div class="name"></div>
                        <div class="jgId"></div>
                    </div>
                </div>
                <div id="profile-stats">
                    <div class="stat-item">
                        <span id="profile-friends-count">0</span>
                        <span>Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="profile-followers-count">0</span>
                        <span>Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="profile-likes-count">0</span>
                        <span>Likes</span>
                    </div>
                </div>

                <div id="profile-options">
                     <button id="show-qr-btn" class="text-icon-btn primary">
                        <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg>
                        <span>My Profile QR</span>
                    </button>
                    <button id="boost-dashboard-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path></svg>
                        <span>Boost Dashboard</span>
                    </button>
                    <button id="request-badge-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.5 12.5c0-1.28-.21-2.5-.6-3.63l-1.32.76c.28.89.42 1.83.42 2.87s-.14 1.98-.42 2.87l1.32.76c.39-1.13.6-2.35.6-3.63zm-2.48-5.32c-.52-.9-1.16-1.72-1.9-2.43l-1.13 1.13c.59.57 1.1 1.25 1.52 2.01l1.51-.71zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm-1.04 11.45l-2.83-2.83.71-.71 2.12 2.12 4.95-4.95.71.71-5.66 5.66zM4.98 7.18l1.51.71c.42-.76.93-1.44 1.52-2.01L6.88 4.75c-.74.71-1.38 1.53-1.9 2.43zM2.1 8.87l1.32-.76C3.02 9.22 2.9 10.16 2.9 11.1s.12 1.88.33 2.78l-1.32-.76C1.51 12.04 1.3 11.09 1.3 10.1s.21-1.94.6-2.87zm16.92 7.66l-1.51-.71c-.42.76-.93 1.44-1.52 2.01l1.13 1.13c.74-.71 1.38-1.53 1.9-2.43z"></path></svg>
                        <span>Request Badge</span>
                    </button>
                     <button id="view-my-posts-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></svg>
                        <span>My Post</span>
                    </button>
                     <button id="edit-profile-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
                        <span>Edit My Profile</span>
                     </button>
                    <button id="my-wallet-btn" class="text-icon-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
                        <span>My Wallet</span>
                    </button>
                </div>

                <div id="profile-edit-form" style="display:none;">
                    <input type="text" id="edit-profile-name">
                     <input type="file" id="edit-profile-image" accept="image/*" style="display:none;">
                    <label for="edit-profile-image" class="image-upload-label">Change Picture</label>
                    <input type="file" id="edit-profile-cover" accept="image/*" style="display:none;">
                    <label for="edit-profile-cover" class="image-upload-label">Change Cover Photo</label>
                    <button id="save-profile-changes-btn" class="text-icon-btn primary" style="margin-top: 10px;">Save Changes</button>
                </div>
                
                <div id="blocked-users-section">
                     <h3>Blocked Users</h3>
                    <div id="blocked-users-list" style="max-height: 120px; overflow-y: auto;"></div>
                </div>
                
                <button id="logout-btn">Logout</button>
            </main>
        </div>
        
        <!-- Other User Profile View -->
        <div id="user-profile-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span id="user-profile-page-title" class="page-title">Profile</span>
            </header>
            <main>
                <div id="user-profile-info-display">
                     <img class="profile-cover-photo" alt="Cover Photo">
                     <div class="profile-main-info">
                        <img class="profile-img" alt="Profile Picture">
                        <div class="name"></div>
                     </div>
                </div>
                <div id="user-profile-stats">
                     <div class="stat-item">
                        <span id="user-profile-friends-count">0</span>
                        <span>Friends</span>
                    </div>
                    <div class="stat-item">
                        <span id="user-profile-followers-count">0</span>
                        <span>Followers</span>
                    </div>
                    <div class="stat-item">
                        <span id="user-profile-likes-count">0</span>
                        <span>Likes</span>
                    </div>
                </div>
                <div id="user-profile-actions">
                    <button id="follow-user-btn" class="text-icon-btn primary">
                        <!-- Content will be set by JS -->
                    </button>
                    <!-- MODIFIED: Renamed button to be more general -->
                    <button id="view-all-posts-btn" class="text-icon-btn">
                         <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"></path></svg>
                        <span>View All Posts</span>
                    </button>
                    <button id="user-profile-show-qr-btn" class="text-icon-btn">
                         <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg>
                        <span>Show QR Code</span>
                    </button>
                </div>
                <h3 style="padding: 15px 20px 5px; font-weight: 500; color: var(--wa-header-bg); border-top: 8px solid var(--wa-app-bg);">Recent Posts</h3>
                <div id="user-profile-posts-list" style="width:100%;"></div>
            </main>
        </div>

        <!-- NEW: User's All Posts View -->
        <div id="user-all-posts-view" class="view" style="display: none;">
             <header class="page-header">
                 <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span id="user-all-posts-title" class="page-title">All Posts</span>
             </header>
            <main>
                <div id="user-all-posts-list" style="width:100%;"></div>
            </main>
        </div>


        <!-- QR Scanner View -->
        <div id="qr-scanner-view" class="view" style="display: none;">
             <header class="page-header">
                  <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Scan QR Code</span>
             </header>
             <main style="justify-content: center; align-items:center; background: #333;">
                <div id="qr-reader"></div>
            </main>
        </div>
        
        <!-- Channel Chat View -->
        <div id="chat-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                     <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <img id="chat-header-img" class="list-item-profile-img" alt="Profile Pic">
                <div id="chat-header-info" class="list-item-details">
                    <div id="chat-header-name" class="list-item-name"></div>
                     <div id="chat-header-subtext" class="list-item-subtext"></div>
                </div>
                <div class="header-actions">
                    <button id="chat-more-btn" class="icon-btn" title="More options">
                        <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
                    </button>
                </div>
            </header>

            <div id="channel-options-menu" class="post-dropdown-menu" style="top: 50px; right: 10px; width: 200px; z-index: 20;">
                <button id="view-channel-members-btn">View Members</button>
                <button id="show-channel-qr-btn">Show Channel QR</button>
                <button id="edit-channel-btn">Edit Channel Info</button>
                <button id="delete-channel-btn" style="color: #d93025;">Delete Channel</button>
            </div>

            <main id="chat-messages" style="background-color: var(--wa-chat-bg);"></main>

            <footer id="chat-input-container">
                <textarea id="chat-input" placeholder="Message" rows="1"></textarea>
                <button id="chat-send-btn">
                     <svg viewBox="0 0 24 24" fill="white" width="24px" height="24px"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </footer>
        </div>
        
        <!-- Badge Request View -->
        <div id="badge-request-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">Request a Badge</span>
            </header>
            <main>
                <p style="text-align: center; color: var(--wa-text-secondary); margin-bottom: 20px;">
                    Choose a package to get a verified blue badge and post with images.
                </p>
                <div id="badge-packages-container">
                    <!-- Package options will be dynamically inserted here by JavaScript -->
                </div>
            </main>
        </div>

        <!-- Wallet View -->
        <div id="wallet-view" class="view" style="display: none;">
            <header class="page-header">
                <button class="back-btn icon-btn">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"></path></svg>
                </button>
                <span class="page-title">My Wallet</span>
                <button id="add-money-btn" class="icon-btn" title="Add Money" style="margin-left: auto;">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path></svg>
                </button>
            </header>
            <main>
                <div class="wallet-card total-balance-card">
                    <div class="balance-title">Total Balance</div>
                    <div class="balance-amount" id="wallet-total-balance">$0.00</div>
                </div>

                <div class="wallet-card">
                    <div class="balance-item">
                        <span class="balance-title">Main Balance</span>
                        <span class="balance-amount" id="wallet-main-balance">$0.00</span>
                    </div>
                     <div class="balance-item">
                        <span class="balance-title">Refer Balance</span>
                        <span class="balance-amount" id="wallet-refer-balance">$0.00</span>
                    </div>
                     <div class="balance-item">
                        <span class="balance-title">Coupon Balance</span>
                        <span class="balance-amount" id="wallet-coupon-balance">$0.00</span>
                    </div>
                </div>

                <div class="history-section">
                    <h3>Transaction History</h3>
                    <div class="transaction-list" id="wallet-history-list">
                        <!-- History items will be inserted here -->
                    </div>
                </div>
            </main>
        </div>
        
        <!-- Modals -->
        <div id="profile-setup-modal" class="modal"> 
            <div class="modal-content" style="gap: 10px;"> 
                <h2>Set up your Profile</h2> 
                <input type="text" id="profile-name-input" placeholder="Your Name" required> 
                <select id="profile-gender-select" required>
                    <option value="" disabled selected>Select Gender</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
                <input type="date" id="profile-dob-input" required>
                <input type="file" id="profile-image-input" accept="image/*" style="display: none;"> 
                <label for="profile-image-input" class="image-upload-label">Upload Profile Picture (Optional)</label> 
                <input type="file" id="profile-cover-input" accept="image/*" style="display: none;"> 
                <label for="profile-cover-input" class="image-upload-label">Upload Cover Photo (Optional)</label> 
                <button id="save-profile-btn">Save Profile</button> 
            </div> 
        </div>
        <div id="add-friend-modal" class="modal"> <div class="modal-content"> <h2>Add Friend</h2> <p>Enter your friend's App ID (e.g., jg-1234)</p> <div style="display:flex; gap:10px; align-items:center;"> <input type="text" id="add-friend-id-input" placeholder="jg-xxxx" style="flex-grow:1;"> <button id="scan-qr-btn" class="icon-btn" title="Scan QR Code" style="color: var(--wa-header-bg); flex-shrink:0; width:44px; height:44px; background-color: var(--wa-app-bg);"><svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm8-12v8h8V3h-8zm6 6h-4V5h4v4zm-2 12h-4v-2h2v-2h2v4zM13 13h-2v2h2v-2zm4 0h-2v2h2v-2zm-2 2h-2v2h2v-2zm4 0h-2v2h2v-2zm2-4h-2v2h2v-2zm0-2h-2v2h2v-2zm-2 6h-2v2h2v-2zm-6-4h2v-2h-2v2z"></path></svg></button> </div> <div class="modal-actions"> <button id="close-add-friend-modal-btn" class="secondary">Cancel</button> <button id="send-friend-request-btn">Send Request</button> </div> </div> </div>
        <div id="create-channel-modal" class="modal"> <div class="modal-content"> <h2>Create New Channel</h2> <input type="text" id="channel-name-input" placeholder="Channel Name" required> <select id="channel-type-select" style="margin-top: 10px; padding: 12px;"><option value="public" selected>Public Channel (All can message)</option><option value="private">Private Channel (Only Admin can message)</option></select> <input type="file" id="channel-image-input" accept="image/*" style="display:none;"> <label for="channel-image-input" class="image-upload-label">Upload Channel Picture</label> <div class="modal-actions"> <button id="close-create-channel-modal-btn" class="secondary">Cancel</button> <button id="create-channel-btn">Create</button> </div> </div> </div>
        <div id="edit-channel-modal" class="modal"> <div class="modal-content"> <h2>Edit Channel Info</h2> <input type="text" id="edit-channel-name-input" placeholder="Channel Name" required> <input type="file" id="edit-channel-image-input" accept="image/*" style="display: none;"> <label for="edit-channel-image-input" class="image-upload-label">Change Channel Picture</label> <div class="modal-actions"> <button id="close-edit-channel-modal-btn" class="secondary">Cancel</button> <button id="save-channel-changes-btn">Save Changes</button> </div> </div> </div>
        <div id="channel-members-modal" class="modal"> <div class="modal-content"> <h2>Channel Members</h2> <div id="channel-members-list" style="max-height: 300px; overflow-y: auto;"></div> <button id="close-channel-members-modal-btn" class="secondary" style="margin-top: 15px;">Close</button> </div> </div>
        <div id="qr-code-modal" class="modal"> <div class="modal-content"> <h2>Scan this Code</h2> <div id="qr-code-display"></div> <p style="text-align:center; font-size:16px; font-weight:500;" id="qr-code-text"></p> <button id="close-qr-modal-btn" class="secondary">Close</button> </div> </div>
        <div id="exit-confirm-modal" class="modal"> <div class="modal-content"> <h2>Exit App?</h2> <p style="text-align:center;">Are you sure you want to exit?</p> <div class="modal-actions" style="justify-content:space-around;"> <button id="exit-no-btn" class="secondary">No</button> <button id="exit-yes-btn">Yes</button> </div> </div> </div>
        
        <!-- UPDATED: Boost Post Modal -->
        <div id="boost-post-modal" class="modal">
            <div class="modal-content">
                <h2>Boost Post</h2>
                <label for="boost-days-input">Select duration (days):</label>
                <input type="number" id="boost-days-input" value="1" min="1" max="30">

                <label for="boost-button-type-select">Button Type (Optional):</label>
                <select id="boost-button-type-select">
                    <option value="none" selected>None</option>
                    <option value="watch">Watch</option>
                    <option value="download">Download</option>
                    <option value="visit">Visit</option>
                    <option value="view_more">View More</option>
                </select>

                <div id="boost-link-container" style="display: none; width:100%; display:none; flex-direction:column; gap: 5px;">
                    <label for="boost-button-link-input" id="boost-link-label">Button Link (URL):</label>
                    <input type="text" id="boost-button-link-input" placeholder="https://example.com">
                </div>

                <p style="text-align: center; font-weight: 500; margin-top: 10px;">
                    Total Cost: $<span id="boost-total-cost">1.00</span>
                </p>
                <div class="modal-actions">
                    <button id="close-boost-modal-btn" class="secondary">Cancel</button>
                    <button id="confirm-boost-btn">Boost Now</button>
                </div>
            </div>
        </div>
        
        <div id="edit-post-modal" class="modal">
            <div class="modal-content">
                <h2>Edit Post</h2>
                <textarea id="edit-post-textarea" rows="6"></textarea>
                <div class="modal-actions">
                    <button id="close-edit-modal-btn" class="secondary">Cancel</button>
                    <button id="save-edit-post-btn">Save Changes</button>
                </div>
            </div>
        </div>
        <div id="post-image-view-modal" class="modal">
            <div class="modal-content">
                <img id="post-image-view-src" src="" alt="Post Image">
                <div class="modal-actions" style="justify-content: flex-end;">
                    <button id="close-post-image-view-btn" class="secondary">Close</button>
                </div>
            </div>
        </div>
        <div id="add-money-modal" class="modal">
            <div class="modal-content">
                <h2>Add Money with Redeem Code</h2>
                <div id="redeem-message" class="error-message"></div>
                <input type="text" id="redeem-code-input" placeholder="Enter Redeem Code" required>
                <select id="balance-type-select" required>
                    <option value="main" selected>Add to Main Balance</option>
                    <option value="coupon">Add to Coupon Balance</option>
                </select>
                <div class="modal-actions">
                    <button id="close-add-money-modal-btn" class="secondary">Cancel</button>
                    <button id="confirm-redeem-btn">Redeem</button>
                </div>
            </div>
        </div>

     </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = { apiKey: "AIzaSyA2BfcS9qjzdT70cEcM4kMqDLfzInbMloY", authDomain: "textsms-6bc0b.firebaseapp.com", databaseURL: "https://textsms-6bc0b-default-rtdb.firebaseio.com", projectId: "textsms-6bc0b", storageBucket: "textsms-6bc0b.appspot.com", messagingSenderId: "259023315417", appId: "1:259023315417:web:f335e5ffec03ef390179c8", measurementId: "G-6FV78CN212" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- CLOUDINARY CONFIG ---
        const cloudinaryConfig = { cloudName: "dzmo138qb", uploadPreset: "textsms" };
        
        // --- GLOBAL STATE ---
        let currentUser = null, currentChannel = null;
        let totalNotifications = 0, currentView = 'loading-view', html5QrCode = null, scannerMode = null;
        let postImageFile = null; 
        let badgePackagesConfig = null;
        let appInitialized = false;
        let boostCostPerDay = 1.00; 
        let postIntersectionObserver;
        const notificationSound = new Audio('data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaW5nIGN1cmV6YUBnbWFpbC5jb20AAAARTGF2ZjU2LjQwLjEwMQAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9//tAwAAAAAAAAAAAAAAAAAAAAAAA/gwgYwAAA+gwgYwAADAmgwgYwAAAAAAAAAAAAAAA2cIAAAAAAAAAAAAAAAAAAAAAAADAAAAAAAAAADD/2/9');


        // --- HARDCODED CONFIGURATION ---
        const hardcodedBadgePackagesConfig = {
            "silver": {
                "name": "Silver Package",
                "priceUSD": 1.00,
                "durationDays": 7,
                "postLimitPerDay": 10,
                "iconColor": "#A9A9A9"
            },
            "gold": {
                "name": "Gold Package",
                "priceUSD": 1.99,
                "durationDays": 15,
                "postLimitPerDay": 10,
                "iconColor": "#FFD700"
            },
            "diamond": {
                "name": "Diamond Package",
                "priceUSD": 3.99,
                "durationDays": 30,
                "postLimitPerDay": 10,
                "iconColor": "#b9f2ff"
            }
        };

        // --- UI ELEMENT SELECTORS ---
        const allViews = document.querySelectorAll('.view');
        const allContentPanels = document.querySelectorAll('.content-panel');
        
        // --- NAVIGATION ---
        const _internalShowView = (viewId) => {
            currentView = viewId;
            allViews.forEach(v => v.style.display = 'none');
            const viewElement = document.getElementById(viewId);
            if (viewElement) {
                viewElement.style.display = 'flex';
                // Trigger view-specific load functions
                if (viewId === 'profile-view') openProfileView();
                if (viewId === 'wallet-view') renderWalletView();
                if (viewId === 'badge-request-view') renderBadgePackages();
                if (viewId === 'boost-dashboard-view') renderBoostDashboard();
            }
        };

        const showView = (viewId, pushState = true) => {
            if (currentView !== viewId) {
                _internalShowView(viewId);
                if (pushState) {
                    history.pushState({ view: viewId }, '', `#${viewId}`);
                }
            }
        };

        const goBack = () => {
            history.back();
        };
        
        const showModal = (modalId, show = true) => { document.getElementById(modalId).style.display = show ? 'flex' : 'none'; };
        const showPanel = (panelId) => {
            allContentPanels.forEach(p => p.classList.remove('active'));
            document.getElementById(panelId).classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            if (panelId === 'channels-content') document.getElementById('nav-channels').classList.add('active');
            if (panelId === 'posts-content') document.getElementById('nav-posts').classList.add('active'); 
        };

        // --- UTILITY FUNCTIONS ---
        const generateJgId = () => `jg-${Math.floor(1000 + Math.random() * 9000)}`;
        const escapeHTML = (str) => str.replace(/[&<>"']/g, (match) => ({'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[match]));
        const linkify = (inputText) => { const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig; return inputText.replace(urlRegex, (url) => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`); };
        
        function formatNumber(num) {
            if (isNaN(num)) return num;
            if (num >= 1000000000) return (num / 1000000000).toFixed(1).replace(/\.0$/, '') + 'B';
            if (num >= 1000000) return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            return num;
        }

        async function uploadImage(file) { if (!file) return null; if (!cloudinaryConfig.cloudName || !cloudinaryConfig.uploadPreset) { alert("Cloudinary is not configured."); return null; } const formData = new FormData(); formData.append('file', file); formData.append('upload_preset', cloudinaryConfig.uploadPreset); try { const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/image/upload`, { method: 'POST', body: formData }); const data = await response.json(); return data.secure_url ? data.secure_url : Promise.reject(data.error.message); } catch (error) { console.error('Cloudinary upload failed:', error); alert(`Image upload failed: ${error.message}`); return null; } }

        const getBlueBadgeIcon = (hasBadge) => {
            if (!hasBadge) return '';
            return `<svg class="blue-badge" viewBox="0 0 24 24" fill="#34B7F1"><path d="M22.5 12.5c0-1.28-.21-2.5-.6-3.63l-1.32.76c.28.89.42 1.83.42 2.87s-.14 1.98-.42 2.87l1.32.76c.39-1.13.6-2.35.6-3.63zm-2.48-5.32c-.52-.9-1.16-1.72-1.9-2.43l-1.13 1.13c.59.57 1.1 1.25 1.52 2.01l1.51-.71zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm-1.04 11.45l-2.83-2.83.71-.71 2.12 2.12 4.95-4.95.71.71-5.66 5.66zM4.98 7.18l1.51.71c.42-.76.93-1.44 1.52-2.01L6.88 4.75c-.74.71-1.38 1.53-1.9 2.43zM2.1 8.87l1.32-.76C3.02 9.22 2.9 10.16 2.9 11.1s.12 1.88.33 2.78l-1.32-.76C1.51 12.04 1.3 11.09 1.3 10.1s.21-1.94.6-2.87zm16.92 7.66l-1.51-.71c-.42.76-.93 1.44-1.52 2.01l1.13 1.13c.74-.71 1.38-1.53 1.9-2.43z"></path></svg>`;
        };

        async function calculateTotalLikes(userId) {
            let totalLikes = 0;
            const postsRef = db.ref('posts').orderByChild('authorUid').equalTo(userId);
            const snapshot = await postsRef.once('value');
            if (snapshot.exists()) {
                snapshot.forEach(postSnapshot => {
                    if (postSnapshot.hasChild('reactions/like')) {
                        totalLikes += postSnapshot.child('reactions/like').numChildren();
                    }
                });
            }
            return totalLikes;
        }
        
        // --- AUTHENTICATION & APP INITIALIZATION ---
        auth.onAuthStateChanged(user => { 
            if (user) { 
                const userRef = db.ref(`users/${user.uid}`);
                userRef.on('value', (snapshot) => { 
                    if (snapshot.exists()) { 
                        currentUser = { uid: user.uid, ...snapshot.val() }; 
                        
                        const headerImg = document.getElementById('header-profile-img');
                        if (headerImg) headerImg.src = currentUser.profileImageUrl;
                        
                        if (!appInitialized) {
                            initializeApp(); 
                            appInitialized = true;
                        }
                        
                        if (currentView === 'loading-view' || currentView === 'auth-view') {
                             showView('main-view', false); 
                        }
                    } else { 
                        showView('auth-view', false);
                        showModal('profile-setup-modal'); 
                    } 
                }); 
            } else { 
                currentUser = null;
                appInitialized = false; 
                showView('auth-view', false);
            } 
        });
        
        function setupBackButtonHandler() {
            history.replaceState({view: 'main-view'}, '', '#main-view');

            window.onpopstate = (event) => {
                if (!currentUser) return;
                if (html5QrCode && html5QrCode.isScanning) html5QrCode.stop();
                
                if (event.state && event.state.view) {
                    _internalShowView(event.state.view);
                } else {
                    if (currentView !== 'main-view') {
                        showView('main-view', true);
                    } else {
                        showModal('exit-confirm-modal');
                        history.pushState({view: 'main-view'}, '', '#main-view');
                    }
                }
            };
            document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', goBack));
        }

        document.getElementById('exit-yes-btn').addEventListener('click', () => { showModal('exit-confirm-modal', false); history.back(); });
        document.getElementById('exit-no-btn').addEventListener('click', () => showModal('exit-confirm-modal', false));

        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => document.getElementById('login-error').textContent = err.message); });
        document.getElementById('signup-form').addEventListener('submit', (e) => { e.preventDefault(); auth.createUserWithEmailAndPassword(document.getElementById('signup-email').value, document.getElementById('signup-password').value).then(cred => { currentUser = { uid: cred.user.uid, email: cred.user.email }; showModal('profile-setup-modal'); }).catch(err => document.getElementById('signup-error').textContent = err.message); });
        document.getElementById('logout-btn').addEventListener('click', () => { auth.signOut(); });
        document.getElementById('show-signup').addEventListener('click', () => { document.getElementById('login-form').style.display = 'none'; document.getElementById('signup-form').style.display = 'flex'; });
        document.getElementById('show-login').addEventListener('click', () => { document.getElementById('signup-form').style.display = 'none'; document.getElementById('login-form').style.display = 'flex'; });
        
        document.getElementById('save-profile-btn').addEventListener('click', async () => { 
            const name = document.getElementById('profile-name-input').value.trim(); 
            const gender = document.getElementById('profile-gender-select').value;
            const dob = document.getElementById('profile-dob-input').value;
            const imageFile = document.getElementById('profile-image-input').files[0]; 
            const coverFile = document.getElementById('profile-cover-input').files[0];
            if (!name || !gender || !dob) { return alert('Name, Gender, and Date of Birth are required.'); }
            const btn = document.getElementById('save-profile-btn'); 
            btn.disabled = true; btn.textContent = "Saving..."; 
            const imageUrl = await uploadImage(imageFile);
            const coverUrl = await uploadImage(coverFile);
            const profileData = { name, gender, dob, profileImageUrl: imageUrl || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random`, coverImageUrl: coverUrl || '', jgId: generateJgId(), email: currentUser.email, contacts: {}, blocked: {}, followers: {}, following: {}, hasBlueBadge: false, wallet: { main: 1000.00, refer: 0, coupon: 0}, badgeInfo: { packageType: 'free', expiryTimestamp: 0 } }; 
            db.ref(`users/${currentUser.uid}`).set(profileData).then(() => { showModal('profile-setup-modal', false); btn.disabled = false; btn.textContent = "Save Profile"; }).catch(err => alert("Profile setup failed: " + err.message)); 
        });
        
        function loadBadgePackageConfig() {
            badgePackagesConfig = hardcodedBadgePackagesConfig;
        }

        function initializeApp() {
            loadBadgePackageConfig();
            listenForFriendRequests();
            renderCallLogs();
            listenAndRenderChannels();
            listenAndRenderPosts();
            listenForNotifications();
            listenForBoostApprovals();
            listenForRejectedRequests(); // ADDED: Listener for refunds
            setupBackButtonHandler();
            setupIntersectionObserver();
        }

        // --- UI NAVIGATION LISTENERS ---
        document.getElementById('nav-posts').addEventListener('click', () => showPanel('posts-content'));
        document.getElementById('nav-channels').addEventListener('click', () => showPanel('channels-content'));
        document.getElementById('menu-btn').addEventListener('click', () => showView('profile-view'));
        document.getElementById('add-friend-btn').addEventListener('click', () => showModal('add-friend-modal'));
        document.getElementById('notification-btn').addEventListener('click', () => showView('notifications-view'));
        document.getElementById('request-badge-btn').addEventListener('click', () => showView('badge-request-view'));
        document.getElementById('my-wallet-btn').addEventListener('click', () => showView('wallet-view'));
        document.getElementById('boost-dashboard-btn').addEventListener('click', () => showView('boost-dashboard-view')); // ADDED
        document.getElementById('close-add-friend-modal-btn').addEventListener('click', () => showModal('add-friend-modal', false));
        document.getElementById('show-create-channel-modal-btn').addEventListener('click', () => showModal('create-channel-modal'));
        document.getElementById('close-create-channel-modal-btn').addEventListener('click', () => showModal('create-channel-modal', false));
        document.getElementById('close-post-image-view-btn').addEventListener('click', () => showModal('post-image-view-modal', false));

        // --- QR Code & Scanner ---
        document.getElementById('show-qr-btn').addEventListener('click', () => { const qrDisplay = document.getElementById('qr-code-display'); qrDisplay.innerHTML = ''; new QRCode(qrDisplay, { text: currentUser.jgId, width: 200, height: 200 }); document.getElementById('qr-code-text').textContent = currentUser.jgId; showModal('qr-code-modal'); });
        document.getElementById('close-qr-modal-btn').addEventListener('click', () => showModal('qr-code-modal', false));
        function startScanner(mode) { scannerMode = mode; showView('qr-scanner-view'); html5QrCode = new Html5Qrcode("qr-reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess).catch(err => alert("QR Code scanning failed. Please grant camera permissions.")); }
        document.getElementById('scan-qr-btn').addEventListener('click', () => startScanner('addUser'));
        document.getElementById('scan-join-channel-btn').addEventListener('click', () => startScanner('joinChannel'));
        function onScanSuccess(decodedText, decodedResult) { if (html5QrCode && html5QrCode.isScanning) { html5QrCode.stop(); } if (scannerMode === 'addUser') { showModal('add-friend-modal', false); sendFriendRequestById(decodedText); } else if (scannerMode === 'joinChannel') { joinChannelByCode(decodedText); } goBack();}

        // --- FRIEND & CHANNEL ---
        function sendFriendRequestById(friendId) { if (!friendId) return; db.ref('users').orderByChild('jgId').equalTo(friendId).once('value', snapshot => { if (snapshot.exists()) { const friendUid = Object.keys(snapshot.val())[0]; if(friendUid === currentUser.uid) { alert("You can't add yourself."); return; } db.ref(`users/${friendUid}`).once('value', friendSnap => { const friendData = friendSnap.val(); const request = { name: currentUser.name, profileImageUrl: currentUser.profileImageUrl, type: 'incoming' }; db.ref(`requests/${friendUid}/${currentUser.uid}`).set(request).then(() => { alert('Friend request sent!'); }); }); } else { alert('User not found.'); } }); }
        document.getElementById('send-friend-request-btn').addEventListener('click', () => { const friendId = document.getElementById('add-friend-id-input').value.trim(); sendFriendRequestById(friendId); showModal('add-friend-modal', false); document.getElementById('add-friend-id-input').value = ''; });
        const generateChannelCode = () => `chan-${Math.floor(1000 + Math.random() * 9000)}`;
        document.getElementById('create-channel-btn').addEventListener('click', async () => { const channelName = document.getElementById('channel-name-input').value.trim(); const channelType = document.getElementById('channel-type-select').value; const imageFile = document.getElementById('channel-image-input').files[0]; if (!channelName || !imageFile) return alert('Channel Name and Picture are required.'); const button = document.getElementById('create-channel-btn'); button.disabled = true; button.textContent = "Creating..."; const imageUrl = await uploadImage(imageFile); if (!imageUrl) { button.disabled = false; button.textContent = "Create"; return; } const newChannelRef = db.ref('channels').push(); const channelCode = generateChannelCode(); const channelData = { info: { name: channelName, type: channelType, profileImageUrl: imageUrl, creatorUid: currentUser.uid, creatorName: currentUser.name, createdAt: firebase.database.ServerValue.TIMESTAMP, code: channelCode }, members: { [currentUser.uid]: true } }; newChannelRef.set(channelData).then(() => { db.ref(`users/${currentUser.uid}/channels/${newChannelRef.key}`).set(true); alert(`Channel "${channelName}" created! Your join code is: ${channelCode}`); showModal('create-channel-modal', false); document.getElementById('channel-name-input').value = ''; document.getElementById('channel-image-input').value = ''; button.disabled = false; button.textContent = "Create"; }); });
        function joinChannelByCode(code) { if (!code) return; db.ref('channels').orderByChild('info/code').equalTo(code).once('value', snapshot => { if (snapshot.exists()) { const channelId = Object.keys(snapshot.val())[0]; const channelName = snapshot.val()[channelId].info.name; db.ref(`channels/${channelId}/members/${currentUser.uid}`).set(true); db.ref(`users/${currentUser.uid}/channels/${channelId}`).set(true).then(() => { alert(`Successfully joined "${channelName}"!`); showView('main-view'); showPanel('channels-content'); }); } else { alert('Channel not found. Please check the code.'); showView('main-view'); } }); }
        document.getElementById('join-channel-btn').addEventListener('click', () => { const code = document.getElementById('join-channel-input').value.trim(); joinChannelByCode(code); });
        function listenAndRenderChannels() { const list = document.getElementById('channel-list'); db.ref(`users/${currentUser.uid}/channels`).on('value', snapshot => { list.innerHTML = ''; if (!snapshot.exists()) { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 40px 20px;">You have not joined any channels yet.</p>'; return; } snapshot.forEach(childSnapshot => { const channelId = childSnapshot.key; db.ref(`channels/${channelId}/info`).once('value', infoSnap => { if (infoSnap.exists()) { const info = infoSnap.val(); const div = document.createElement('div'); div.className = 'list-item'; div.onclick = () => { openChannelChat(channelId, info); showView('chat-view'); }; div.innerHTML = `<img src="${info.profileImageUrl}" class="list-item-profile-img" alt="Ch"><div class="list-item-details"><div class="list-item-name">${info.name}</div><div class="list-item-subtext">Code: ${info.code}</div></div>`; list.appendChild(div); } }); }); }); }
        document.getElementById('show-channel-qr-btn').addEventListener('click', () => { if (!currentChannel) return; const qrDisplay = document.getElementById('qr-code-display'); qrDisplay.innerHTML = ''; new QRCode(qrDisplay, { text: currentChannel.code, width: 200, height: 200 }); document.getElementById('qr-code-text').textContent = currentChannel.code; document.getElementById('channel-options-menu').style.display = 'none'; showModal('qr-code-modal'); });
        document.getElementById('edit-channel-btn').addEventListener('click', () => { if (!currentChannel) return; document.getElementById('edit-channel-name-input').value = currentChannel.name; showModal('edit-channel-modal'); document.getElementById('channel-options-menu').style.display = 'none'; });
        document.getElementById('close-edit-channel-modal-btn').addEventListener('click', () => showModal('edit-channel-modal', false));
        document.getElementById('save-channel-changes-btn').addEventListener('click', async () => { if (!currentChannel) return; const button = document.getElementById('save-channel-changes-btn'); button.disabled = true; button.textContent = "Saving..."; const newName = document.getElementById('edit-channel-name-input').value.trim(); const imageFile = document.getElementById('edit-channel-image-input').files[0]; const updates = {}; if (newName && newName !== currentChannel.name) { updates['info/name'] = newName; } if (imageFile) { const newImageUrl = await uploadImage(imageFile); if (newImageUrl) { updates['info/profileImageUrl'] = newImageUrl; } } if (Object.keys(updates).length > 0) { await db.ref(`channels/${currentChannel.id}`).update(updates); } button.disabled = false; button.textContent = "Save Changes"; showModal('edit-channel-modal', false); alert("Channel info updated!"); goBack(); });
        document.getElementById('delete-channel-btn').addEventListener('click', async () => { if (!currentChannel) return; if (confirm(`Are you sure you want to permanently delete the channel "${currentChannel.name}"? This action cannot be undone.`)) { const channelId = currentChannel.id; const membersSnapshot = await db.ref(`channels/${channelId}/members`).once('value'); if (membersSnapshot.exists()) { const memberUids = Object.keys(membersSnapshot.val()); const promises = memberUids.map(uid => db.ref(`users/${uid}/channels/${channelId}`).remove()); await Promise.all(promises); } await db.ref(`channel_messages/${channelId}`).remove(); await db.ref(`channels/${channelId}`).remove(); alert(`Channel "${currentChannel.name}" has been deleted.`); showView('main-view');} document.getElementById('channel-options-menu').style.display = 'none'; });
        
        // --- NOTIFICATIONS & FRIEND REQUESTS ---
        function updateNotificationBadge() { const badge = document.getElementById('notification-badge'); badge.textContent = totalNotifications; badge.style.display = totalNotifications > 0 ? 'block' : 'none'; }
        
        // MODIFIED: Use child_added for sounds
        function listenForNotifications() {
            const postNotificationsList = document.getElementById('post-notifications-list');
            const notificationsRef = db.ref(`notifications/${currentUser.uid}`);
            
            notificationsRef.on('child_added', child => {
                const notif = { id: child.key, ...child.val() };
                if (appInitialized && !notif.read) { // Play sound only for new notifications after app loads
                    notificationSound.play().catch(e => console.log("Audio play failed, user interaction needed."));
                }
                renderSingleNotification(notif, postNotificationsList);
                updateUnreadCount();
            });

            notificationsRef.on('child_changed', child => {
                const notif = { id: child.key, ...child.val() };
                renderSingleNotification(notif, postNotificationsList); // Re-render to show as "read"
                updateUnreadCount();
            });
            
             notificationsRef.on('child_removed', child => {
                const el = document.getElementById(`notif-${child.key}`);
                if (el) el.remove();
                updateUnreadCount();
            });

            // Initial load
            notificationsRef.once('value', snapshot => {
                postNotificationsList.innerHTML = '';
                if(snapshot.exists()) {
                    snapshot.forEach(child => renderSingleNotification({ id: child.key, ...child.val() }, postNotificationsList));
                }
                updateUnreadCount();
            });
        }

        function renderSingleNotification(notification, container) {
            let existingDiv = document.getElementById(`notif-${notification.id}`);
            if(existingDiv) existingDiv.remove();

            const div = document.createElement('div');
            div.id = `notif-${notification.id}`;
            div.className = 'notification-item';
            if (!notification.read) div.classList.add('unread');
            div.onclick = (event) => goToPostFromNotification(notification.postId, notification.id, event);
            
            let fromUserImage = notification.fromUserImage || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'%23ccc\'%3E%3Cpath d=\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z\'/%3E%3C/svg%3E';
            div.innerHTML = `<img src="${fromUserImage}" class="list-item-profile-img" style="width:40px; height:40px;" alt="P"><div class="list-item-details"><div class="list-item-name">${escapeHTML(notification.fromUserName || 'System') }</div><div class="list-item-subtext">${escapeHTML(notification.text)}</div></div>`;
            
            container.prepend(div); // Prepend to show newest on top
            if (container.childElementCount > 0 && container.querySelector('p')) {
                 container.querySelector('p').remove();
            }
        }

        function updateUnreadCount() {
            const postNotificationsList = document.getElementById('post-notifications-list');
            db.ref(`notifications/${currentUser.uid}`).orderByChild('read').equalTo(false).once('value', notifSnapshot => {
                let unreadPostNotifs = notifSnapshot.numChildren();
                if(postNotificationsList.childElementCount === 0) postNotificationsList.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">No new post notifications.</p>';

                db.ref(`requests/${currentUser.uid}`).once('value', requestSnapshot => {
                    let incomingRequestCount = 0;
                    if(requestSnapshot.exists()){ requestSnapshot.forEach(child => { if(child.val().type === 'incoming') incomingRequestCount++; }); }
                    totalNotifications = unreadPostNotifs + incomingRequestCount;
                    updateNotificationBadge();
                });
            });
        }
        
        function listenForFriendRequests() { db.ref(`requests/${currentUser.uid}`).on('value', snapshot => { const list = document.getElementById('friend-requests-list'); list.innerHTML = ''; let incomingRequestCount = 0; if (snapshot.exists()) { snapshot.forEach(childSnapshot => { const request = childSnapshot.val(); const fromUid = childSnapshot.key; if (currentUser.blocked && currentUser.blocked[fromUid]) return; const div = document.createElement('div'); div.className = 'list-item'; div.style.cursor = 'default'; const type = request.type || 'incoming'; switch (type) { case 'incoming': incomingRequestCount++; if(appInitialized) notificationSound.play().catch(e => {}); div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Wants to be your friend</div></div><div class="list-item-actions"><button onclick="handleFriendRequest('${fromUid}', true)">Accept</button><button class="reject" onclick="handleFriendRequest('${fromUid}', false)">Reject</button></div>`; break; case 'accepted': div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Accepted your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('requests', '${fromUid}')">Dismiss</button></div>`; break; case 'rejected': div.innerHTML = `<img src="${request.profileImageUrl}" class="list-item-profile-img" alt="P"><div class="list-item-details"><div class="list-item-name">${request.name}</div><div class="list-item-subtext">Declined your friend request.</div></div><div class="list-item-actions"><button class="reject" onclick="dismissNotification('requests', '${fromUid}')">Dismiss</button></div>`; break; } if (div.innerHTML) { list.appendChild(div); } }); } if (list.childElementCount === 0) { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">No new friend requests.</p>'; } 
            updateUnreadCount();
        }); }
        window.dismissNotification = (type, notificationId) => { db.ref(`${type}/${currentUser.uid}/${notificationId}`).remove(); };
        window.handleFriendRequest = (fromUid, accepted) => { db.ref(`requests/${currentUser.uid}/${fromUid}`).remove(); const notification = { name: currentUser.name, profileImageUrl: currentUser.profileImageUrl, type: accepted ? 'accepted' : 'rejected' }; db.ref(`requests/${fromUid}/${currentUser.uid}`).set(notification); if (accepted) { db.ref(`users/${currentUser.uid}/contacts/${fromUid}`).set(true); db.ref(`users/${fromUid}/contacts/${currentUser.uid}`).set(true); } };
        
        // --- CHANNEL CHAT ---
        async function openChannelChat(channelId, channelInfo) { 
            db.ref(`channel_messages/${channelId}`).off(); 
            currentChannel = { id: channelId, ...channelInfo }; 
            
            document.getElementById('chat-header-img').src = channelInfo.profileImageUrl; 
            document.getElementById('chat-header-name').textContent = channelInfo.name; 
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = ''; 
            document.getElementById('chat-more-btn').style.display = 'flex'; 
            
            const chatInputContainer = document.getElementById('chat-input-container'); 
            const channelType = channelInfo.type || 'public';
            const isAdmin = currentUser.uid === channelInfo.creatorUid;
            const canSendMessage = (channelType === 'public' || isAdmin);
            
            chatInputContainer.style.display = canSendMessage ? 'flex' : 'none';
            document.getElementById('edit-channel-btn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('delete-channel-btn').style.display = isAdmin ? 'block' : 'none';
             
            db.ref(`channels/${channelId}/members`).on('value', snapshot => { 
                document.getElementById('chat-header-subtext').textContent = `${snapshot.numChildren()} members`; 
            }); 
            
            db.ref(`channel_messages/${channelId}`).limitToLast(50).on('child_added', (snapshot) => {
                 renderOrUpdateChannelMessage(snapshot, messagesContainer);
            }); 
        }

        function renderOrUpdateChannelMessage(snapshot, container) { 
            const msg = snapshot.val(); 
            const div = document.createElement('div'); 
            const messageClass = msg.sender === currentUser.uid ? 'message-sent' : 'message-received'; 
            div.className = 'message-bubble ' + messageClass; 
            let contentHTML = linkify(escapeHTML(msg.text || '')); 
            
            let senderNameHTML = '';
            if (msg.sender !== currentUser.uid) {
                senderNameHTML = `<div style="font-weight: 500; color: var(--wa-header-bg); font-size:13px;">${escapeHTML(msg.senderName)}</div>`;
            }
            
            div.innerHTML = `${senderNameHTML}<div>${contentHTML}</div>`; 
            container.appendChild(div); 
            container.scrollTop = container.scrollHeight; 
        }

        document.getElementById('chat-send-btn').addEventListener('click', sendMessage);
        document.getElementById('chat-input').addEventListener('keypress', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                sendMessage(); 
            } 
            const textarea = e.target;
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        });
        
        function sendMessage() { 
            const input = document.getElementById('chat-input'); 
            const text = input.value.trim(); 
            if (!text || !currentChannel) return; 
            const messageData = { 
                type: 'text', 
                text: text, 
                sender: currentUser.uid, 
                senderName: currentUser.name, 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            }; 
            db.ref(`channel_messages/${currentChannel.id}`).push(messageData); 
            input.value = ''; 
            input.style.height = 'auto'; 
        }
        
        // --- CALLS (History View Only) ---
        function renderCallLogs() { const list = document.getElementById('call-logs-list'); db.ref(`callLogs/${currentUser.uid}`).orderByChild('timestamp').limitToLast(30).on('value', snapshot => { list.innerHTML = ''; if (!snapshot.exists()) { list.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">No recent calls.</p>'; return; } const logs = []; snapshot.forEach(child => logs.push(child.val())); logs.reverse().forEach(log => { const div = document.createElement('div'); div.className = 'list-item'; div.style.cursor = 'default'; div.innerHTML = `<img src="${log.partnerProfileImageUrl}" class="list-item-profile-img" alt="P"> <div class="list-item-details"> <div class="list-item-name">${log.partnerName} (${log.type})</div> <div class="list-item-subtext">${log.status} - ${new Date(log.timestamp).toLocaleString()}</div> </div>`; list.appendChild(div); }); }); }
        
        // --- PROFILE, BADGE & WALLET ---
        async function openProfileView() { 
            const hasActiveBadge = currentUser.badgeInfo && currentUser.badgeInfo.expiryTimestamp > Date.now();
            const display = document.getElementById('profile-info-display'); 
            display.querySelector('.profile-cover-photo').src = currentUser.coverImageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            display.querySelector('.profile-img').src = currentUser.profileImageUrl; 
            display.querySelector('.name').innerHTML = `${escapeHTML(currentUser.name)} ${getBlueBadgeIcon(hasActiveBadge)}`; 
            display.querySelector('.jgId').textContent = `ID: ${currentUser.jgId}`; 
            document.getElementById('profile-friends-count').textContent = Object.keys(currentUser.contacts || {}).length; 
            document.getElementById('profile-followers-count').textContent = Object.keys(currentUser.followers || {}).length; 
            document.getElementById('profile-likes-count').textContent = '...'; 
            calculateTotalLikes(currentUser.uid).then(totalLikes => { document.getElementById('profile-likes-count').textContent = formatNumber(totalLikes); }); 
            document.getElementById('edit-profile-name').value = currentUser.name; 
            document.getElementById('profile-options').style.display = 'flex'; 
            document.getElementById('profile-edit-form').style.display = 'none'; 
            renderBlockedUsers(); 
        }

        function renderBadgePackages() {
            const container = document.getElementById('badge-packages-container');
            container.innerHTML = ''; 
            if (!badgePackagesConfig) {
                container.innerHTML = '<p style="text-align:center;">Packages are currently unavailable.</p>';
                return;
            }
            const packageIcons = { silver: `<svg class="badge-package-icon" viewBox="0 0 24 24" fill="${badgePackagesConfig.silver.iconColor || '#A9A9A9'}"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"></path></svg>`, gold: `<svg class="badge-package-icon" viewBox="0 0 24 24" fill="${badgePackagesConfig.gold.iconColor || '#FFD700'}"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"></path></svg>`, diamond: `<svg class="badge-package-icon" viewBox="0 0 24 24" fill="${badgePackagesConfig.diamond.iconColor || '#b9f2ff'}"><path d="M12.1 1.14l-10 4.83c-.38.18-.6.58-.6.99v10.08c0 .41.22.81.6.99l10 4.83c.38.18.82.18 1.2 0l10-4.83c.38-.18.6-.58-.6-.99V7c0-.41-.22-.81-.6-.99l-10-4.83c-.38-.19-.82-.19-1.2 0zM12 4.24l7.47 3.6L12 11.33 4.53 7.84 12 4.24zM3 8.81l8 3.86v8.46L3 17.19V8.81zm18 0v8.38l-8 3.94v-8.46l8-3.86z"></path></svg>` };
            for (const packageId in badgePackagesConfig) {
                const package = badgePackagesConfig[packageId];
                const packageDiv = document.createElement('div');
                packageDiv.className = 'badge-package-option';
                packageDiv.innerHTML = `<div class="badge-package-header">${packageIcons[packageId] || ''}<h3>${escapeHTML(package.name)}</h3></div><ul class="badge-package-features"><li>${package.durationDays} দিনের জন্য Blue badge</li><li>দিনে ${package.postLimitPerDay} টি করে ছবিসহ পোস্ট</li></ul><div class="badge-price">$${package.priceUSD.toFixed(2)}</div><button class="badge-purchase-btn" onclick="purchaseBadge('${packageId}')">Purchase Now</button>`;
                container.appendChild(packageDiv);
            }
        }
        
        async function purchaseBadge(packageId) {
            if (!badgePackagesConfig || !badgePackagesConfig[packageId]) return alert("Could not find package details.");
            
            const package = badgePackagesConfig[packageId];
            const cost = package.priceUSD;

            if (!confirm(`Confirm purchase of ${package.name} for $${cost.toFixed(2)}? This amount will be deducted from your wallet (Coupon > Refer > Main).`)) return;
            
            const paymentResult = await deductFunds(cost, `Badge: ${package.name}`);
            if (!paymentResult.success) {
                alert(paymentResult.message);
                return;
            }

            try {
                const updates = paymentResult.updates;
                // Create badge request for admin to approve/activate
                const newRequestKey = db.ref('badgeRequests').push().key;
                updates[`badgeRequests/${newRequestKey}`] = {
                    userId: currentUser.uid,
                    userName: currentUser.name,
                    jgId: currentUser.jgId,
                    packageName: package.name,
                    packageId: packageId,
                    durationDays: package.durationDays,
                    costUSD: cost,
                    status: 'pending',
                    requestedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                await db.ref().update(updates);
                alert(`Purchase successful! Your request for the ${package.name} has been sent for admin activation.`);
                
            } catch (error) {
                alert("An error occurred during purchase. Please try again.");
                console.error("Badge purchase failed: ", error);
            }
        }
        window.purchaseBadge = purchaseBadge;

        function renderWalletView() {
            const wallet = currentUser.wallet || { main: 0, refer: 0, coupon: 0 };
            const mainBalance = (wallet.main || 0).toFixed(2);
            const referBalance = (wallet.refer || 0).toFixed(2);
            const couponBalance = (wallet.coupon || 0).toFixed(2);
            const totalBalance = ((wallet.main || 0) + (wallet.refer || 0) + (wallet.coupon || 0)).toFixed(2);
            
            document.getElementById('wallet-main-balance').textContent = `$${mainBalance}`;
            document.getElementById('wallet-refer-balance').textContent = `$${referBalance}`;
            document.getElementById('wallet-coupon-balance').textContent = `$${couponBalance}`;
            document.getElementById('wallet-total-balance').textContent = `$${totalBalance}`;
            
            const historyList = document.getElementById('wallet-history-list');
            historyList.innerHTML = '<p style="text-align: center; padding: 20px;">Loading history...</p>';
            
            db.ref(`transactionHistory/${currentUser.uid}`).orderByChild('timestamp').limitToLast(25).once('value', snapshot => {
                historyList.innerHTML = '';
                if (!snapshot.exists()) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px;">No transactions found.</p>';
                    return;
                }
                let transactions = [];
                snapshot.forEach(child => transactions.push(child.val()));
                transactions.reverse().forEach(tx => {
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    const amountClass = tx.amount > 0 ? 'credit' : 'debit';
                    const amountSign = tx.amount > 0 ? '+' : '';
                    item.innerHTML = `<div class="transaction-details"><div class="reason">${escapeHTML(tx.reason)}</div><div class="timestamp">${new Date(tx.timestamp).toLocaleString()}</div></div><div class="transaction-amount ${amountClass}">${amountSign}$${Math.abs(tx.amount).toFixed(2)}</div>`;
                    historyList.appendChild(item);
                });
            });
        }
        
        document.getElementById('edit-profile-btn').addEventListener('click', () => { document.getElementById('profile-options').style.display = 'none'; document.getElementById('profile-edit-form').style.display = 'flex'; });
        document.getElementById('save-profile-changes-btn').addEventListener('click', async () => { const button = document.getElementById('save-profile-changes-btn'); button.disabled = true; button.textContent = "Saving..."; const newName = document.getElementById('edit-profile-name').value.trim(); const imageFile = document.getElementById('edit-profile-image').files[0]; const coverFile = document.getElementById('edit-profile-cover').files[0]; let updates = {}; if (newName) updates.name = newName; if (imageFile) { const newImageUrl = await uploadImage(imageFile); if (newImageUrl) updates.profileImageUrl = newImageUrl; } if (coverFile) { const newCoverUrl = await uploadImage(coverFile); if (newCoverUrl) updates.coverImageUrl = newCoverUrl; } db.ref(`users/${currentUser.uid}`).update(updates).then(() => { alert("Profile updated successfully!"); button.disabled = false; button.textContent = "Save Changes"; openProfileView(); }).catch(err => { alert("Update failed: " + err.message); button.disabled = false; button.textContent = "Save Changes"; }); });
        document.getElementById('chat-more-btn').addEventListener('click', (e) => { e.stopPropagation(); const menu = document.getElementById('channel-options-menu'); menu.style.display = menu.style.display === 'block' ? 'none' : 'block'; });
        document.addEventListener('click', () => { const menu = document.getElementById('channel-options-menu'); if(menu) menu.style.display = 'none'; const postMenus = document.querySelectorAll('.post-dropdown-menu'); postMenus.forEach(m => m.style.display = 'none'); });
        
        window.unblockUser = (uidToUnblock) => { db.ref(`users/${currentUser.uid}/blocked/${uidToUnblock}`).remove().then(() => { alert('User unblocked.'); renderBlockedUsers(); }); }
        function renderBlockedUsers() { const list = document.getElementById('blocked-users-list'); list.innerHTML = ''; db.ref(`users/${currentUser.uid}/blocked`).once('value', snapshot => { if (!snapshot.exists()) { list.innerHTML = '<p style="font-size:12px; text-align:center; color: #667781;">No users blocked.</p>'; return; } snapshot.forEach(childSnapshot => { db.ref(`users/${childSnapshot.key}`).once('value', userSnap => { if (userSnap.exists()) { const user = userSnap.val(); const item = document.createElement('div'); item.className = 'list-item'; item.innerHTML = `<img src="${user.profileImageUrl}" class="list-item-profile-img" alt="U"><div class="list-item-details"><div class="list-item-name">${user.name}</div></div><div class="list-item-actions"><button onclick="unblockUser('${childSnapshot.key}')">Unblock</button></div>`; list.appendChild(item); } }); }); }); }
        
        // --- CHANNEL MODAL ---
        document.getElementById('view-channel-members-btn').addEventListener('click', async () => { if (!currentChannel) return; const list = document.getElementById('channel-members-list'); list.innerHTML = '<p>Loading members...</p>'; showModal('channel-members-modal'); const membersSnap = await db.ref(`channels/${currentChannel.id}/members`).once('value'); if (!membersSnap.exists()) { list.innerHTML = '<p>No members found.</p>'; return; } list.innerHTML = ''; const memberUids = Object.keys(membersSnap.val()); memberUids.forEach(uid => { db.ref(`users/${uid}`).once('value', userSnap => { if (userSnap.exists()) { const user = userSnap.val(); const hasActiveBadge = user.badgeInfo && user.badgeInfo.expiryTimestamp > Date.now(); const item = document.createElement('div'); item.className = 'list-item'; item.style.cursor = 'default'; item.innerHTML = `<img src="${user.profileImageUrl}" class="list-item-profile-img" alt="M"><div class="list-item-details"><div class="list-item-name">${escapeHTML(user.name)} ${getBlueBadgeIcon(hasActiveBadge)}</div></div>`; list.appendChild(item); } }); }); });
        document.getElementById('close-channel-members-modal-btn').addEventListener('click', () => showModal('channel-members-modal', false));

        // --- POST FEATURE FUNCTIONS ---
        document.getElementById('add-post-image-btn').addEventListener('click', () => { document.getElementById('post-image-input').click(); });
        document.getElementById('post-image-input').addEventListener('change', (e) => { const file = e.target.files[0]; if (!file) return; postImageFile = file; const reader = new FileReader(); reader.onload = (event) => { document.getElementById('post-image-preview').src = event.target.result; document.getElementById('post-image-preview-container').style.display = 'block'; }; reader.readAsDataURL(file); });
        document.getElementById('remove-post-image-btn').addEventListener('click', () => { resetPostImageSelection(); });
        function resetPostImageSelection() { postImageFile = null; const input = document.getElementById('post-image-input'); input.value = ''; document.getElementById('post-image-preview-container').style.display = 'none'; document.getElementById('post-image-preview').src = ''; }
        
        document.getElementById('create-post-btn').addEventListener('click', async () => {
            const hasActivePackage = currentUser.badgeInfo && currentUser.badgeInfo.expiryTimestamp && currentUser.badgeInfo.expiryTimestamp > Date.now();
            if (postImageFile && !hasActivePackage) {
                alert('ছবিসহ পোস্ট করতে অনুগ্রহ করে আপনার প্যাকেজ আপগ্রেড করুন।');
                showView('badge-request-view');
                return;
            }

            const postBtn = document.getElementById('create-post-btn');
            const textArea = document.getElementById('post-textarea');
            const text = textArea.value.trim();
            if (!text && !postImageFile) { return alert("Post cannot be empty. Please add text or an image."); }
            postBtn.disabled = true; postBtn.textContent = 'Posting...';
            const postData = { authorUid: currentUser.uid, authorName: currentUser.name, authorProfileImageUrl: currentUser.profileImageUrl, timestamp: firebase.database.ServerValue.TIMESTAMP };
            try {
                if (postImageFile) {
                    const imageUrl = await uploadImage(postImageFile);
                    if (imageUrl) { postData.imageUrl = imageUrl; } else { throw new Error("Image upload failed."); }
                }
                if (text) { postData.text = text; }
                await db.ref('posts').push(postData);
                textArea.value = ''; resetPostImageSelection();
            } catch (err) { alert(err.message || "Could not create post."); } 
            finally { postBtn.disabled = false; postBtn.textContent = 'Post'; }
        });
        
        function listenAndRenderPosts() {
            const postsRef = db.ref('posts').orderByChild('timestamp');
            const feed = document.getElementById('posts-feed');
            
            postsRef.on('child_added', (snapshot) => { renderSinglePost(snapshot, feed, true); });
            postsRef.on('child_changed', (snapshot) => { renderSinglePost(snapshot, feed, false, document.getElementById(`post-${snapshot.key}`)); });
            postsRef.on('child_removed', (snapshot) => { const postElement = document.getElementById(`post-${snapshot.key}`); if (postElement) postElement.remove(); });
        }

        async function renderSinglePost(snapshot, containerElement, prepend = true, replaceElement = null) {
            const postId = snapshot.key;
            const postData = snapshot.val();
            if (!postData) return;
            if (!replaceElement && document.getElementById(`post-${postId}`)) return;

            const userSnap = await db.ref(`users/${postData.authorUid}`).once('value');
            let authorHasBadge = false;
            if (userSnap.exists()) {
                const userData = userSnap.val();
                authorHasBadge = userData.badgeInfo && userData.badgeInfo.expiryTimestamp && userData.badgeInfo.expiryTimestamp > Date.now();
            }
            
            const postContainer = document.createElement('div');
            postContainer.id = `post-${postId}`;
            postContainer.dataset.postId = postId; // For IntersectionObserver
            
            const postCard = document.createElement('div');
            postCard.className = 'post-card';
            const time = new Date(postData.timestamp).toLocaleString();
            
            const isMyPost = postData.authorUid === currentUser.uid;
            let actionButtonHtml = isMyPost ? `<button class="post-action-btn" onclick="openBoostModal('${postId}')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2z"></path></svg><span>Boost Now</span></button>` : '';
            
            const isBoosted = postData.boostInfo && postData.boostInfo.status === 'active' && postData.boostInfo.endDate > Date.now();
            const sponsoredLabelHtml = isBoosted ? `<div class="sponsored-label">Sponsored</div>` : '';
            
            let boostButtonHtml = '';
            if (isBoosted && postData.boostInfo.buttonType && postData.boostInfo.buttonType !== 'none' && postData.boostInfo.buttonLink) {
                const buttonText = postData.boostInfo.buttonType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                boostButtonHtml = `<a onclick="handleBoostClick('${postId}', '${escapeHTML(postData.boostInfo.buttonLink)}')" class="boost-cta-button">${escapeHTML(buttonText)}</a>`;
            }

            let postContentHtml = '';
            if (postData.imageUrl) { postContentHtml += `<img src="${postData.imageUrl}" alt="Post image" class="post-image" onclick="viewPostImage('${postData.imageUrl}')">`; }
            if (postData.text) { postContentHtml += `<div class="post-text-content" style="${postData.imageUrl ? 'margin-top:10px;' : ''}">${linkify(escapeHTML(postData.text))}</div>`; }
            postContentHtml += boostButtonHtml; // Add boost button here


            const postMenuId = `post-menu-${postId}`;
            const postMenu = `<div style="position: relative;"><button class="icon-btn post-menu-btn" onclick="togglePostMenu(event, '${postMenuId}')"><svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg></button><div id="${postMenuId}" class="post-dropdown-menu">${isMyPost ? `<button onclick="openEditModal('${postId}')">Edit Post</button>` : ''}${postData.imageUrl ? `<button onclick="savePostImage('${postData.imageUrl}')">Save Image</button>` : ''}${postData.text ? `<button onclick="copyPostText(\`${encodeURIComponent(postData.text)}\`)">Copy Text</button>` : ''}<button onclick="sharePost(\`${encodeURIComponent(postData.text || '')}\`, \`${encodeURIComponent(postData.imageUrl || '')}\`)">Share</button>${isMyPost ? `<button style="color: #d93025;" onclick="deletePost('${postId}')">Delete Post</button>` : `<button onclick="reportPost('${postId}', '${postData.authorUid}')">Report</button>`}</div></div>`;
            
            postCard.innerHTML = `<div class="post-header"><img src="${postData.authorProfileImageUrl}" alt="${postData.authorName}" class="post-author-img" onclick="showView('user-profile-view'); openUserProfileView('${postData.authorUid}')"><div class="post-author-info"><div class="name" onclick="showView('user-profile-view'); openUserProfileView('${postData.authorUid}')">${escapeHTML(postData.authorName)} ${getBlueBadgeIcon(authorHasBadge)}</div>${sponsoredLabelHtml}<div class="timestamp">${time}</div></div>${postMenu}</div><div class="post-content">${postContentHtml}</div><div class="post-actions"><button class="post-action-btn" id="like-btn-${postId}" onclick="handleReaction('${postId}', '${postData.authorUid}')"><svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-1.91l-.01-.01L23 10z"></path></svg><span id="like-text-${postId}">Like</span><span id="like-count-${postId}" style="margin-left: 4px; font-weight: normal;"></span></button><button class="post-action-btn" onclick="toggleComments('${postId}', '${postData.authorUid}')"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"></path></svg><span>Comment</span><span id="comment-count-${postId}" style="margin-left: 4px; font-weight: normal;"></span></button>${actionButtonHtml}</div>`;
            const commentsSection = document.createElement('div');
            commentsSection.className = 'post-comments-section';
            commentsSection.id = `comments-for-${postId}`;
            commentsSection.style.display = 'none';

            postContainer.appendChild(postCard);
            postContainer.appendChild(commentsSection);

            if (replaceElement) {
                if (postIntersectionObserver) postIntersectionObserver.unobserve(replaceElement);
                containerElement.replaceChild(postContainer, replaceElement);
            } else if (prepend) {
                containerElement.prepend(postContainer);
            } else {
                containerElement.appendChild(postContainer);
            }

            if (isBoosted && postIntersectionObserver) {
                postIntersectionObserver.observe(postContainer);
            }

            db.ref(`posts/${postId}/reactions/like`).on('value', likeSnapshot => {
                const count = likeSnapshot.numChildren();
                const likeButton = document.getElementById(`like-btn-${postId}`);
                const countSpan = document.getElementById(`like-count-${postId}`);
                const likeTextSpan = document.getElementById(`like-text-${postId}`);
                if(countSpan) { countSpan.textContent = count > 0 ? formatNumber(count) : ''; }
                if (likeButton) { if (likeSnapshot.hasChild(currentUser.uid)) { likeButton.classList.add('liked'); if (likeTextSpan) likeTextSpan.textContent = 'Liked'; } else { likeButton.classList.remove('liked'); if (likeTextSpan) likeTextSpan.textContent = 'Like'; } }
            });

            db.ref(`posts/${postId}/comments`).on('value', commentSnapshot => {
                const count = commentSnapshot.numChildren();
                const countSpan = document.getElementById(`comment-count-${postId}`);
                if (countSpan) { countSpan.textContent = count > 0 ? formatNumber(count) : ''; }
            });
        }
        
        window.togglePostMenu = (event, menuId) => { event.stopPropagation(); const menu = document.getElementById(menuId); const isVisible = menu.style.display === 'block'; document.querySelectorAll('.post-dropdown-menu').forEach(m => m.style.display = 'none'); if (menu) menu.style.display = isVisible ? 'none' : 'block'; };
        window.viewPostImage = (imageUrl) => { document.getElementById('post-image-view-src').src = imageUrl; showModal('post-image-view-modal'); };
        window.copyPostText = (encodedText) => { const text = decodeURIComponent(encodedText); navigator.clipboard.writeText(text).then(() => alert('Text copied!'), () => alert('Failed to copy.')); };
        window.savePostImage = (imageUrl) => { const link = document.createElement('a'); link.href = imageUrl; link.download = 'post_image.jpg'; document.body.appendChild(link); link.click(); document.body.removeChild(link); };
        window.sharePost = (encodedText, encodedImageUrl) => { const text = decodeURIComponent(encodedText); const shareData = { title: 'Post from Kotha App', text: text, url: window.location.href }; if (navigator.share) navigator.share(shareData); };
        window.reportPost = (postId) => { if(confirm("Report this post?")) alert("Post reported."); };
        function createNotification(targetUid, type, text, postId) { if (targetUid === currentUser.uid && type !== 'boost_approved' && type !== 'request_rejected') return; db.ref(`notifications/${targetUid}`).push().set({ fromUserId: currentUser.uid, fromUserName: currentUser.name, fromUserImage: currentUser.profileImageUrl, type: type, text: text, postId: postId, timestamp: firebase.database.ServerValue.TIMESTAMP, read: false }); }
        window.handleReaction = (postId, postAuthorUid) => { const reactionRef = db.ref(`posts/${postId}/reactions/like/${currentUser.uid}`); reactionRef.once('value', snapshot => { if (snapshot.exists()) { reactionRef.remove(); } else { reactionRef.set(true); createNotification(postAuthorUid, 'like', 'liked your post.', postId); } }); };
        window.toggleComments = (postId, postAuthorUid) => { const commentsSection = document.getElementById(`comments-for-${postId}`); if (commentsSection.style.display === 'none') { commentsSection.style.display = 'block'; renderComments(postId, postAuthorUid); } else { commentsSection.style.display = 'none'; commentsSection.innerHTML = ''; } };
        async function renderComments(postId, postAuthorUid) { const commentsSection = document.getElementById(`comments-for-${postId}`); commentsSection.innerHTML = `<div style="display:flex; gap:10px; margin-top:15px;"><input type="text" id="comment-input-${postId}" placeholder="Write a comment..." style="flex-grow:1; border: 1px solid #ccc; border-radius:15px; padding: 8px 12px; font-size:14px;"><button onclick="addComment('${postId}', '${postAuthorUid}')" style="border:none; background:none; color: var(--wa-header-bg); font-weight:500; cursor:pointer;">Post</button></div><div id="comment-list-${postId}"></div>`; db.ref(`posts/${postId}/comments`).on('child_added', snapshot => { const commentData = snapshot.val(), commentId = snapshot.key; const commentDiv = document.createElement('div'); commentDiv.className = 'comment-item'; commentDiv.id = `comment-${commentId}`; let deleteBtn = (commentData.authorUid === currentUser.uid) ? `<span class="comment-delete-btn" onclick="deleteComment('${postId}', '${commentId}')">Delete</span>` : ''; commentDiv.innerHTML = `<img src="${commentData.authorProfileImageUrl}" alt="${commentData.authorName}" class="comment-author-img"><div class="comment-content">${deleteBtn}<div class="comment-author-name">${escapeHTML(commentData.authorName)}</div><div>${linkify(escapeHTML(commentData.text))}</div></div>`; document.getElementById(`comment-list-${postId}`).prepend(commentDiv); }); }
        window.deleteComment = (postId, commentId) => { if (confirm("Delete this comment?")) { db.ref(`posts/${postId}/comments/${commentId}`).remove(); } };
        window.addComment = (postId, postAuthorUid) => { const input = document.getElementById(`comment-input-${postId}`); const text = input.value.trim(); if(!text) return; const commentData = { authorUid: currentUser.uid, authorName: currentUser.name, authorProfileImageUrl: currentUser.profileImageUrl, text: text, timestamp: firebase.database.ServerValue.TIMESTAMP }; db.ref(`posts/${postId}/comments`).push(commentData).then(() => { input.value = ''; createNotification(postAuthorUid, 'comment', `commented: ${text.substring(0, 20)}...`, postId); }); };
        
        window.goToPostFromNotification = (postId, notificationId, event) => {
            if (event && event.currentTarget) event.currentTarget.classList.remove('unread');
            db.ref(`notifications/${currentUser.uid}/${notificationId}`).update({ read: true });
            if (!postId) return;
            showView('main-view'); showPanel('posts-content');
            const checkExist = setInterval(() => {
                const postElement = document.getElementById(`post-${postId}`);
                if (postElement) {
                    clearInterval(checkExist);
                    postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    postElement.querySelector('.post-card').classList.add('highlight');
                    setTimeout(() => postElement.querySelector('.post-card').classList.remove('highlight'), 2000);
                }
            }, 100);
        };
        
        // --- MY POSTS & USER PROFILE VIEWS (MODIFIED) ---
        document.getElementById('view-my-posts-btn').addEventListener('click', () => { showView('my-posts-view'); showMyPostsView(); });
        
        function showMyPostsView() { 
            const list = document.getElementById('my-posts-list'); 
            list.innerHTML = 'Loading...'; 
            db.ref('posts').orderByChild('authorUid').equalTo(currentUser.uid).once('value', snapshot => { 
                list.innerHTML = ''; 
                if (!snapshot.exists()) { 
                    list.innerHTML = '<p style="text-align:center; padding: 40px;">You have no posts yet.</p>'; 
                    return; 
                } 
                let posts = []; 
                snapshot.forEach(child => {
                    posts.push({ id: child.key, ...child.val() });
                }); 
                posts.reverse().forEach(post => { 
                    const postDiv = document.createElement('div');
                    postDiv.className = 'post-card';
                    const time = new Date(post.timestamp).toLocaleString(); 
                    let content = post.text ? `<div class="post-content">${linkify(escapeHTML(post.text))}</div>` : ''; 
                    if (post.imageUrl) content += `<img src="${post.imageUrl}" class="post-image" onclick="viewPostImage('${post.imageUrl}')">`; 
                    postDiv.innerHTML = `<div class="post-header"><img src="${post.authorProfileImageUrl}" class="list-item-profile-img" style="width:40px;height:40px;"><div class="post-author-info"><div class="name">${escapeHTML(post.authorName)}</div><div class="timestamp">${time}</div></div><div class="post-controls"><span class="edit-post-btn post-control-btn" onclick="openEditModal('${post.id}')">Edit</span><span class="delete-post-btn post-control-btn" onclick="deletePost('${post.id}')">Delete</span></div></div>${content}`; 
                    list.appendChild(postDiv); 
                }); 
            }); 
        }

        window.deletePost = (postId) => { if (confirm("Delete this post?")) { db.ref(`posts/${postId}`).remove().then(() => { if (currentView === 'my-posts-view') showMyPostsView(); if (currentView === 'user-all-posts-view') goBack(); }); } };
        
        async function openUserProfileView(userId) { 
            const userSnap = await db.ref(`users/${userId}`).once('value'); 
            if (!userSnap.exists()) return; 
            const userData = userSnap.val(); 
            const userHasActiveBadge = userData.badgeInfo && userData.badgeInfo.expiryTimestamp > Date.now(); 
            document.getElementById('user-profile-page-title').textContent = userData.name; 
            const infoDisplay = document.getElementById('user-profile-info-display'); 
            infoDisplay.querySelector('.profile-cover-photo').src = userData.coverImageUrl || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
            infoDisplay.querySelector('.profile-img').src = userData.profileImageUrl; 
            infoDisplay.querySelector('.name').innerHTML = `${escapeHTML(userData.name)} ${getBlueBadgeIcon(userHasActiveBadge)}`; 
            document.getElementById('user-profile-friends-count').textContent = Object.keys(userData.contacts || {}).length; 
            document.getElementById('user-profile-followers-count').textContent = Object.keys(userData.followers || {}).length; 
            document.getElementById('user-profile-likes-count').textContent = '...'; 
            calculateTotalLikes(userId).then(totalLikes => { document.getElementById('user-profile-likes-count').textContent = formatNumber(totalLikes); }); 
            
            const followBtn = document.getElementById('follow-user-btn'); 
            const viewPostsBtn = document.getElementById('view-all-posts-btn');
            
            if (userId === currentUser.uid) {
                document.getElementById('user-profile-actions').style.display = 'none';
                 // If viewing own profile, redirect to the main profile view
                showView('profile-view');
                return;
            } else {
                 document.getElementById('user-profile-actions').style.display = 'flex';
            }
            
            const isFollowing = currentUser.following && currentUser.following[userId]; 
            followBtn.innerHTML = isFollowing ? `Following` : `Follow`; 
            followBtn.onclick = () => toggleFollow(userId); 

            viewPostsBtn.onclick = () => showUserAllPosts(userId, userData.name);
            
            document.getElementById('user-profile-show-qr-btn').onclick = () => { const qrDisplay = document.getElementById('qr-code-display'); qrDisplay.innerHTML = ''; new QRCode(qrDisplay, { text: userData.jgId, width: 200, height: 200 }); document.getElementById('qr-code-text').textContent = userData.jgId; showModal('qr-code-modal'); }; 
            
            const postsList = document.getElementById('user-profile-posts-list'); 
            postsList.innerHTML = 'Loading posts...'; 
            // Load only a few recent posts for the profile preview
            db.ref('posts').orderByChild('authorUid').equalTo(userId).limitToLast(3).once('value', snapshot => { 
                postsList.innerHTML = ''; 
                if (!snapshot.exists()) { 
                    postsList.innerHTML = '<p style="text-align:center; padding: 20px;">No posts yet.</p>'; 
                    return; 
                } 
                let userPosts = []; 
                snapshot.forEach(child => userPosts.push(child)); 
                userPosts.reverse().forEach(postSnap => renderSinglePost(postSnap, postsList, false)); 
            }); 
        }

        function toggleFollow(userIdToFollow) { const followingRef = db.ref(`users/${currentUser.uid}/following/${userIdToFollow}`); const followerRef = db.ref(`users/${userIdToFollow}/followers/${currentUser.uid}`); followingRef.once('value', snapshot => { if (snapshot.exists()) { followingRef.remove(); followerRef.remove(); } else { followingRef.set(true); followerRef.set(true); } openUserProfileView(userIdToFollow); }); }
        
        function showUserAllPosts(userId, userName) {
            showView('user-all-posts-view');
            document.getElementById('user-all-posts-title').textContent = `${userName}'s Posts`;
            const list = document.getElementById('user-all-posts-list');
            list.innerHTML = 'Loading...';
            db.ref('posts').orderByChild('authorUid').equalTo(userId).once('value', snapshot => {
                list.innerHTML = '';
                if (!snapshot.exists()) {
                    list.innerHTML = '<p style="text-align:center; padding: 40px;">This user has no posts yet.</p>';
                    return;
                }
                let posts = [];
                snapshot.forEach(child => posts.push(child));
                posts.reverse().forEach(postSnap => renderSinglePost(postSnap, list, false));
            });
        }


        // --- PAYMENT, BOOST AND EDIT FUNCTIONS ---

        // NEW: Prioritized fund deduction function
        async function deductFunds(totalCost, reason) {
            const updates = {};
            let remainingCost = totalCost;
            
            // 1. Check total available balance first
            const wallet = currentUser.wallet || { coupon: 0, refer: 0, main: 0 };
            const totalAvailable = (wallet.coupon || 0) + (wallet.refer || 0) + (wallet.main || 0);
            if (totalAvailable < totalCost) {
                return { success: false, message: `Insufficient balance. You need $${totalCost.toFixed(2)} but you only have $${totalAvailable.toFixed(2)}.` };
            }

            // 2. Deduct from Coupon Balance
            if (remainingCost > 0 && wallet.coupon > 0) {
                const deductFromCoupon = Math.min(remainingCost, wallet.coupon);
                updates[`users/${currentUser.uid}/wallet/coupon`] = firebase.database.ServerValue.increment(-deductFromCoupon);
                const couponTxKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${couponTxKey}`] = { amount: -deductFromCoupon, reason: `${reason} (from Coupon)`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                remainingCost -= deductFromCoupon;
            }

            // 3. Deduct from Refer Balance
            if (remainingCost > 0 && wallet.refer > 0) {
                const deductFromRefer = Math.min(remainingCost, wallet.refer);
                updates[`users/${currentUser.uid}/wallet/refer`] = firebase.database.ServerValue.increment(-deductFromRefer);
                const referTxKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${referTxKey}`] = { amount: -deductFromRefer, reason: `${reason} (from Refer)`, timestamp: firebase.database.ServerValue.TIMESTAMP };
                remainingCost -= deductFromRefer;
            }

            // 4. Deduct from Main Balance
            if (remainingCost > 0) {
                updates[`users/${currentUser.uid}/wallet/main`] = firebase.database.ServerValue.increment(-remainingCost);
                const mainTxKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${mainTxKey}`] = { amount: -remainingCost, reason: `${reason} (from Main)`, timestamp: firebase.database.ServerValue.TIMESTAMP };
            }

            return { success: true, updates };
        }

        function listenForBoostApprovals() { 
            db.ref('boostRequests').orderByChild('userId').equalTo(currentUser.uid).on('child_changed', snapshot => { 
                const request = { id: snapshot.key, ...snapshot.val() }; 
                if (request.status === 'approved' && !request.notificationSent) { 
                    createNotification(currentUser.uid, 'boost_approved', 'Your post boost has been approved!', request.postId); 
                    notificationSound.play().catch(e => {});
                    db.ref(`boostRequests/${request.id}/notificationSent`).set(true); 
                } 
            }); 
        }
        
        // NEW: Listen for rejections and refund
        function listenForRejectedRequests() {
            // Boost Rejections
            db.ref('boostRequests').orderByChild('userId').equalTo(currentUser.uid).on('child_changed', async (snapshot) => {
                const request = { id: snapshot.key, ...snapshot.val() };
                if (request.status === 'rejected' && !request.refunded) {
                    const updates = {};
                    // 1. Refund to main wallet
                    updates[`users/${currentUser.uid}/wallet/main`] = firebase.database.ServerValue.increment(request.cost);
                    // 2. Mark as refunded
                    updates[`boostRequests/${request.id}/refunded`] = true;
                    // 3. Add transaction history
                    const txKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                    updates[`transactionHistory/${currentUser.uid}/${txKey}`] = {
                        amount: request.cost,
                        reason: `Refund for rejected boost`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    
                    await db.ref().update(updates);
                    createNotification(currentUser.uid, 'request_rejected', `Your boost request was rejected. $${request.cost.toFixed(2)} refunded.`, request.postId);
                    notificationSound.play().catch(e => {});
                }
            });

            // Badge Rejections
            db.ref('badgeRequests').orderByChild('userId').equalTo(currentUser.uid).on('child_changed', async (snapshot) => {
                const request = { id: snapshot.key, ...snapshot.val() };
                 if (request.status === 'rejected' && !request.refunded) {
                    const updates = {};
                    updates[`users/${currentUser.uid}/wallet/main`] = firebase.database.ServerValue.increment(request.costUSD);
                    updates[`badgeRequests/${request.id}/refunded`] = true;
                    const txKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                    updates[`transactionHistory/${currentUser.uid}/${txKey}`] = {
                        amount: request.costUSD,
                        reason: `Refund for rejected badge request`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP
                    };
                    await db.ref().update(updates);
                    createNotification(currentUser.uid, 'request_rejected', `Your badge request was rejected. $${request.costUSD.toFixed(2)} refunded.`, null);
                    notificationSound.play().catch(e => {});
                 }
            });
        }

        function openBoostModal(postId) {
            document.getElementById('boost-days-input').value = 1;
            document.getElementById('boost-button-type-select').value = 'none';
            document.getElementById('boost-button-link-input').value = '';
            document.getElementById('boost-link-container').style.display = 'none';
            document.getElementById('confirm-boost-btn').dataset.postId = postId;
            updateBoostCost();
            showModal('boost-post-modal');
        }

        function updateBoostCost() {
            const days = parseInt(document.getElementById('boost-days-input').value) || 0;
            const totalCost = (days * boostCostPerDay).toFixed(2);
            document.getElementById('boost-total-cost').textContent = totalCost;
        }

        document.getElementById('boost-days-input').addEventListener('input', updateBoostCost);
        document.getElementById('boost-button-type-select').addEventListener('change', (e) => {
            const linkContainer = document.getElementById('boost-link-container');
            if (e.target.value === 'none') {
                linkContainer.style.display = 'none';
            } else {
                linkContainer.style.display = 'flex';
            }
        });
        
        document.getElementById('close-boost-modal-btn').addEventListener('click', () => showModal('boost-post-modal', false));

        document.getElementById('confirm-boost-btn').addEventListener('click', async (e) => {
            const postId = e.target.dataset.postId;
            const days = parseInt(document.getElementById('boost-days-input').value);
            const buttonType = document.getElementById('boost-button-type-select').value;
            const buttonLink = document.getElementById('boost-button-link-input').value.trim();
            const totalCost = days * boostCostPerDay;

            if (isNaN(days) || days < 1) return alert('Please enter a valid number of days.');
            if (buttonType !== 'none' && !buttonLink) return alert('Please provide a link for the button.');

            const paymentResult = await deductFunds(totalCost, `Post Boost (${days} days)`);
            if (!paymentResult.success) {
                alert(paymentResult.message);
                return;
            }

            try {
                const updates = paymentResult.updates;
                // Create boost request for admin to approve
                const newRequestKey = db.ref('boostRequests').push().key;
                updates[`boostRequests/${newRequestKey}`] = {
                    userId: currentUser.uid,
                    postId: postId,
                    durationDays: days,
                    cost: totalCost,
                    buttonType: buttonType,
                    buttonLink: buttonLink,
                    status: 'pending',
                    requestedAt: firebase.database.ServerValue.TIMESTAMP
                };

                await db.ref().update(updates);
                alert('Boost request sent for approval!');
                showModal('boost-post-modal', false);

            } catch (error) {
                alert("Could not send boost request. Please try again.");
                console.error("Boost failed:", error);
            }
        });

        async function openEditModal(postId) { 
            const postSnap = await db.ref(`posts/${postId}`).once('value'); 
            if(postSnap.exists()){ 
                document.getElementById('edit-post-textarea').value = postSnap.val().text || ''; 
                document.getElementById('save-edit-post-btn').dataset.postId = postId; 
                showModal('edit-post-modal'); 
            } 
        }

        document.getElementById('close-edit-modal-btn').addEventListener('click', () => showModal('edit-post-modal', false));
        
        document.getElementById('save-edit-post-btn').addEventListener('click', (e) => { 
            const postId = e.target.dataset.postId; 
            const newText = document.getElementById('edit-post-textarea').value.trim(); 
            db.ref(`posts/${postId}`).update({ text: newText }).then(() => { 
                alert('Post updated!'); 
                showModal('edit-post-modal', false); 
            }); 
        });

        // --- ADD MONEY & REDEEM CODE (MODIFIED & FIXED) ---
        document.getElementById('add-money-btn').addEventListener('click', () => {
            const msgDiv = document.getElementById('redeem-message');
            msgDiv.textContent = '';
            msgDiv.style.color = '#d93025'; // Reset to error color
            document.getElementById('redeem-code-input').value = '';
            showModal('add-money-modal');
        });

        document.getElementById('close-add-money-modal-btn').addEventListener('click', () => {
            showModal('add-money-modal', false);
        });

        document.getElementById('confirm-redeem-btn').addEventListener('click', async () => {
            const codeInput = document.getElementById('redeem-code-input').value.trim();
            const selectedBalanceType = document.getElementById('balance-type-select').value;
            const messageDiv = document.getElementById('redeem-message');
            
            if (!codeInput) {
                messageDiv.textContent = 'Please enter a redeem code.';
                return;
            }

            const redeemCodeRef = db.ref(`redeemCodes/${codeInput}`);
            const snapshot = await redeemCodeRef.once('value');

            if (!snapshot.exists()) {
                messageDiv.textContent = 'Invalid redeem code.';
                return;
            }

            const codeData = snapshot.val();

            if (codeData.usedBy) {
                messageDiv.textContent = 'This code has already been used.';
                return;
            }

            if (codeData.expiryTimestamp && codeData.expiryTimestamp < Date.now()) {
                messageDiv.textContent = 'This code has expired.';
                return;
            }
            
            if (codeData.balanceType !== selectedBalanceType) {
                messageDiv.textContent = `This code is for "${codeData.balanceType}" balance, not "${selectedBalanceType}".`;
                return;
            }

            try {
                const amount = parseFloat(codeData.amount);
                
                const updates = {};
                updates[`users/${currentUser.uid}/wallet/${selectedBalanceType}`] = firebase.database.ServerValue.increment(amount);
                updates[`redeemCodes/${codeInput}/usedBy`] = currentUser.uid;
                updates[`redeemCodes/${codeInput}/usedAt`] = firebase.database.ServerValue.TIMESTAMP;

                const newTransactionKey = db.ref(`transactionHistory/${currentUser.uid}`).push().key;
                updates[`transactionHistory/${currentUser.uid}/${newTransactionKey}`] = {
                    amount: amount,
                    reason: `Redeemed code: ${codeInput}`,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                };

                await db.ref().update(updates);

                messageDiv.style.color = 'green';
                messageDiv.textContent = `Successfully added $${amount.toFixed(2)} to your ${selectedBalanceType} balance!`;
                document.getElementById('redeem-code-input').value = '';
                
            } catch (error) {
                messageDiv.textContent = 'An error occurred. Please try again.';
                console.error("Redeem failed: ", error);
            }
        });

        // --- NEW: BOOST DASHBOARD & VIEW COUNTING ---
        async function renderBoostDashboard() {
            const listContainer = document.getElementById('boost-dashboard-list');
            listContainer.innerHTML = '<p>Loading boosted posts...</p>';
            
            const boostRequestsRef = db.ref('boostRequests').orderByChild('userId').equalTo(currentUser.uid);
            const snapshot = await boostRequestsRef.once('value');

            if (!snapshot.exists()) {
                listContainer.innerHTML = '<p style="text-align:center; color: #667781; padding: 20px;">You have no boosted posts.</p>';
                return;
            }

            listContainer.innerHTML = '';
            let requests = [];
            snapshot.forEach(child => requests.push({ id: child.key, ...child.val() }));
            requests.reverse(); // Show most recent first

            for (const req of requests) {
                const postSnap = await db.ref(`posts/${req.postId}`).once('value');
                if (!postSnap.exists()) continue;
                
                const post = postSnap.val();
                const itemDiv = document.createElement('div');
                itemDiv.className = 'boost-dashboard-item';

                let statusText = req.status.charAt(0).toUpperCase() + req.status.slice(1);
                let statusClass = req.status; // pending, rejected
                if (req.status === 'approved') {
                    if (req.endDate < Date.now()) {
                        statusText = 'Ended';
                        statusClass = 'ended';
                    } else {
                        statusText = 'Active';
                        statusClass = 'active';
                    }
                }
                
                const postImage = post.imageUrl || post.authorProfileImageUrl;
                const postText = post.text ? escapeHTML(post.text) : 'Image Post';

                const viewCount = post.boostViews ? Object.keys(post.boostViews).length : 0;
                const clickCount = post.boostClicks ? Object.keys(post.boostClicks).length : 0;
                const likeCount = post.reactions && post.reactions.like ? Object.keys(post.reactions.like).length : 0;
                
                const startDate = req.startDate ? new Date(req.startDate).toLocaleDateString() : 'N/A';
                const endDate = req.endDate ? new Date(req.endDate).toLocaleDateString() : 'N/A';

                itemDiv.innerHTML = `
                    <div class="boost-item-header">
                        <img src="${postImage}" alt="Post thumbnail">
                        <div class="boost-item-details">
                            <p>${postText}</p>
                            <span class="boost-status ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="boost-item-stats">
                        <div class="boost-stat"><span>${formatNumber(viewCount)}</span> Views</div>
                        <div class="boost-stat"><span>${formatNumber(clickCount)}</span> Clicks</div>
                        <div class="boost-stat"><span>${formatNumber(likeCount)}</span> Likes</div>
                    </div>
                    <div class="boost-item-footer">
                        <span>Duration: ${startDate} to ${endDate}</span>
                    </div>
                `;
                listContainer.appendChild(itemDiv);
            }
        }

        function setupIntersectionObserver() {
            const options = { root: document.getElementById('main-content'), rootMargin: '0px', threshold: 0.5 };
            postIntersectionObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const postId = entry.target.dataset.postId;
                        if (postId) {
                            // Record the view in Firebase
                            db.ref(`posts/${postId}/boostViews/${currentUser.uid}`).set(true);
                            // Stop observing this element after counting the view
                            observer.unobserve(entry.target);
                        }
                    }
                });
            }, options);
        }

        window.handleBoostClick = (postId, link) => {
            // Record the click in Firebase
            db.ref(`posts/${postId}/boostClicks/${currentUser.uid}`).set(true);
            // Open the link in a new tab
            window.open(link, '_blank');
        };

    </script>
</body>
</html>